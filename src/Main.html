<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE ApplicativeDo #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE GADTs #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span><span>
</span><span id="line-6"></span><span>
</span><span id="line-7"></span><span class="hs-comment">-- |</span><span>
</span><span id="line-8"></span><span class="hs-comment">-- Module      :  Main</span><span>
</span><span id="line-9"></span><span class="hs-comment">-- Copyright   :  (c) Simon Zeng, 2021</span><span>
</span><span id="line-10"></span><span class="hs-comment">-- License     :  AGPL v3</span><span>
</span><span id="line-11"></span><span class="hs-comment">--</span><span>
</span><span id="line-12"></span><span class="hs-comment">-- Maintainer  :  contact@simonzeng.com</span><span>
</span><span id="line-13"></span><span class="hs-comment">-- Stability   :  experimental</span><span>
</span><span id="line-14"></span><span class="hs-comment">-- Portability :  portable</span><span>
</span><span id="line-15"></span><span class="hs-comment">--</span><span>
</span><span id="line-16"></span><span class="hs-comment">-- You have an ADT for a hard drive (black blox implementation):</span><span>
</span><span id="line-17"></span><span class="hs-comment">--</span><span>
</span><span id="line-18"></span><span class="hs-comment">-- &gt; class Disk:</span><span>
</span><span id="line-19"></span><span class="hs-comment">-- &gt;   - int length ()</span><span>
</span><span id="line-20"></span><span class="hs-comment">-- &gt;   - int current_position ()</span><span>
</span><span id="line-21"></span><span class="hs-comment">-- &gt;   - char read()</span><span>
</span><span id="line-22"></span><span class="hs-comment">-- &gt;   - void write(char ch)</span><span>
</span><span id="line-23"></span><span class="hs-comment">--</span><span>
</span><span id="line-24"></span><span class="hs-comment">-- and then an ADT for a file system on top of the hard drive:</span><span>
</span><span id="line-25"></span><span class="hs-comment">--</span><span>
</span><span id="line-26"></span><span class="hs-comment">-- &gt; class FileSystem(Disk d)</span><span>
</span><span id="line-27"></span><span class="hs-comment">-- &gt;   - void create_file(string filename, string contents)</span><span>
</span><span id="line-28"></span><span class="hs-comment">-- &gt;   - Read_handle read_file(string filename)</span><span>
</span><span id="line-29"></span><span class="hs-comment">-- &gt;   - void on_disk_spin()</span><span>
</span><span id="line-30"></span><span class="hs-comment">--</span><span>
</span><span id="line-31"></span><span class="hs-comment">-- You can save file metadata in ram.</span><span>
</span><span id="line-32"></span><span class="hs-comment">-- You don't control when or to where the disk spins -- the file system calls the @on_disk_spin@ callback whenever the disk spins.</span><span>
</span><span id="line-33"></span><span class="hs-comment">--</span><span>
</span><span id="line-34"></span><span class="hs-comment">-- First, implement @create_file@ and @on_disk_spin@. e.g. running:</span><span>
</span><span id="line-35"></span><span class="hs-comment">--</span><span>
</span><span id="line-36"></span><span class="hs-comment">-- &gt; create_file(&quot;foo&quot;, &quot;bar&quot;)</span><span>
</span><span id="line-37"></span><span class="hs-comment">-- &gt; create_file(&quot;a&quot;, &quot;b&quot;)</span><span>
</span><span id="line-38"></span><span class="hs-comment">-- &gt; create_file(&quot;baz&quot;, &quot;bar&quot;)</span><span>
</span><span id="line-39"></span><span class="hs-comment">--</span><span>
</span><span id="line-40"></span><span class="hs-comment">-- should give a disk that (eventually, w/ enough spins) has:</span><span>
</span><span id="line-41"></span><span class="hs-comment">--</span><span>
</span><span id="line-42"></span><span class="hs-comment">-- +---------+----------+</span><span>
</span><span id="line-43"></span><span class="hs-comment">-- | filename| contents |</span><span>
</span><span id="line-44"></span><span class="hs-comment">-- +---------+----------+</span><span>
</span><span id="line-45"></span><span class="hs-comment">-- |   foo   |    bar   |</span><span>
</span><span id="line-46"></span><span class="hs-comment">-- +---------+----------+</span><span>
</span><span id="line-47"></span><span class="hs-comment">-- |   a     |    b     |</span><span>
</span><span id="line-48"></span><span class="hs-comment">-- +---------+----------+</span><span>
</span><span id="line-49"></span><span class="hs-comment">-- |   baz   |    bar   |</span><span>
</span><span id="line-50"></span><span class="hs-comment">-- +---------+----------+</span><span>
</span><span id="line-51"></span><span class="hs-comment">--</span><span>
</span><span id="line-52"></span><span class="hs-comment">-- Make sure that your data is set up in a way that allows @read_file@ to be implemented</span><span>
</span><span id="line-53"></span><span class="hs-comment">--</span><span>
</span><span id="line-54"></span><span class="hs-comment">-- To extend: You have a mutable struct @Read_handle@:</span><span>
</span><span id="line-55"></span><span class="hs-comment">--</span><span>
</span><span id="line-56"></span><span class="hs-comment">-- &gt; Read_handle</span><span>
</span><span id="line-57"></span><span class="hs-comment">-- &gt;  - bool done</span><span>
</span><span id="line-58"></span><span class="hs-comment">-- &gt;  - string contents</span><span>
</span><span id="line-59"></span><span class="hs-comment">-- &gt;  - ...</span><span>
</span><span id="line-60"></span><span class="hs-comment">--</span><span>
</span><span id="line-61"></span><span class="hs-comment">-- The @done@ field should be set to true whenever the @contents@ field has all of the contents from the file</span><span>
</span><span id="line-62"></span><span class="hs-comment">--</span><span>
</span><span id="line-63"></span><span class="hs-comment">-- Task: implement @read_file@, and modify @on_disk_spin@ to populate read handles</span><span>
</span><span id="line-64"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Main</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-65"></span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MonadPlus</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">ap</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">guard</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">liftM</span></span><span class="hs-special">)</span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.IO.Class</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MonadIO</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">liftIO</span></span><span class="hs-special">)</span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Reader.Class</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MonadReader</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">ask</span></span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.State.Strict</span></span><span>
</span><span id="line-70"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">MonadState</span></span><span class="hs-special">,</span><span>
</span><span id="line-71"></span><span>    </span><span class="annot"><span class="hs-identifier">get</span></span><span class="hs-special">,</span><span>
</span><span id="line-72"></span><span>    </span><span class="annot"><span class="hs-identifier">modify'</span></span><span class="hs-special">,</span><span>
</span><span id="line-73"></span><span>    </span><span class="annot"><span class="hs-identifier">put</span></span><span class="hs-special">,</span><span>
</span><span id="line-74"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans.Cont</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">callCC</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">evalContT</span></span><span class="hs-special">)</span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans.Reader</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">runReaderT</span></span><span class="hs-special">)</span><span>
</span><span id="line-77"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans.State.Strict</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">evalStateT</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">runStateT</span></span><span class="hs-special">)</span><span>
</span><span id="line-78"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Foldable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">traverse_</span></span><span class="hs-special">)</span><span>
</span><span id="line-79"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.IORef</span></span><span>
</span><span id="line-80"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">IORef</span></span><span class="hs-special">,</span><span>
</span><span id="line-81"></span><span>    </span><span class="annot"><span class="hs-identifier">modifyIORef'</span></span><span class="hs-special">,</span><span>
</span><span id="line-82"></span><span>    </span><span class="annot"><span class="hs-identifier">newIORef</span></span><span class="hs-special">,</span><span>
</span><span id="line-83"></span><span>    </span><span class="annot"><span class="hs-identifier">readIORef</span></span><span class="hs-special">,</span><span>
</span><span id="line-84"></span><span>    </span><span class="annot"><span class="hs-identifier">writeIORef</span></span><span class="hs-special">,</span><span>
</span><span id="line-85"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-86"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map.Strict</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Map</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">maxViewWithKey</span></span><span class="hs-special">)</span><span>
</span><span id="line-87"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map.Strict</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-88"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">fromMaybe</span></span><span class="hs-special">)</span><span>
</span><span id="line-89"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Set</span></span><span class="hs-special">)</span><span>
</span><span id="line-90"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-91"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Prelude</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">read</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">readFile</span></span><span class="hs-special">)</span><span>
</span><span id="line-92"></span><span>
</span><span id="line-93"></span><span class="hs-comment">-- | The provided disk api from the question, translated to haskell</span><span>
</span><span id="line-94"></span><span class="hs-keyword">class</span><span> </span><span id="Disk"><span class="annot"><a href="Main.html#Disk"><span class="hs-identifier hs-var">Disk</span></a></span></span><span> </span><span id="local-6989586621679034322"><span class="annot"><a href="#local-6989586621679034322"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-95"></span><span>  </span><span id="dlength"><span class="annot"><a href="Main.html#dlength"><span class="hs-identifier hs-type">dlength</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679034322"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-96"></span><span>  </span><span id="current_position"><span class="annot"><a href="Main.html#current_position"><span class="hs-identifier hs-type">current_position</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679034322"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-97"></span><span>  </span><span id="read"><span class="annot"><a href="Main.html#read"><span class="hs-identifier hs-type">read</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679034322"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Char</span></span><span>
</span><span id="line-98"></span><span>  </span><span id="write"><span class="annot"><a href="Main.html#write"><span class="hs-identifier hs-type">write</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679034322"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Char</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-99"></span><span>
</span><span id="line-100"></span><span class="hs-comment">-- | Store contents of disks and files as Map instead of array for convenience. perf optimization: replace with array</span><span>
</span><span id="line-101"></span><span class="hs-keyword">newtype</span><span> </span><span id="ContiguousData"><span class="annot"><a href="Main.html#ContiguousData"><span class="hs-identifier hs-var">ContiguousData</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ContiguousData"><span class="annot"><a href="Main.html#ContiguousData"><span class="hs-identifier hs-var">ContiguousData</span></a></span></span><span> </span><span class="hs-special">{</span><span id="cData"><span class="annot"><span class="annottext">ContiguousData -&gt; Map Int Char
</span><a href="Main.html#cData"><span class="hs-identifier hs-var hs-var">cData</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Char</span></span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679034176"><span id="local-6989586621679034178"><span class="annot"><span class="annottext">ContiguousData -&gt; ContiguousData -&gt; Bool
(ContiguousData -&gt; ContiguousData -&gt; Bool)
-&gt; (ContiguousData -&gt; ContiguousData -&gt; Bool) -&gt; Eq ContiguousData
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: ContiguousData -&gt; ContiguousData -&gt; Bool
$c/= :: ContiguousData -&gt; ContiguousData -&gt; Bool
== :: ContiguousData -&gt; ContiguousData -&gt; Bool
$c== :: ContiguousData -&gt; ContiguousData -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679034160"><span id="local-6989586621679034162"><span id="local-6989586621679034164"><span id="local-6989586621679034166"><span id="local-6989586621679034168"><span id="local-6989586621679034170"><span id="local-6989586621679034172"><span class="annot"><span class="annottext">Eq ContiguousData
Eq ContiguousData
-&gt; (ContiguousData -&gt; ContiguousData -&gt; Ordering)
-&gt; (ContiguousData -&gt; ContiguousData -&gt; Bool)
-&gt; (ContiguousData -&gt; ContiguousData -&gt; Bool)
-&gt; (ContiguousData -&gt; ContiguousData -&gt; Bool)
-&gt; (ContiguousData -&gt; ContiguousData -&gt; Bool)
-&gt; (ContiguousData -&gt; ContiguousData -&gt; ContiguousData)
-&gt; (ContiguousData -&gt; ContiguousData -&gt; ContiguousData)
-&gt; Ord ContiguousData
ContiguousData -&gt; ContiguousData -&gt; Bool
ContiguousData -&gt; ContiguousData -&gt; Ordering
ContiguousData -&gt; ContiguousData -&gt; ContiguousData
forall a.
Eq a
-&gt; (a -&gt; a -&gt; Ordering)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; Ord a
min :: ContiguousData -&gt; ContiguousData -&gt; ContiguousData
$cmin :: ContiguousData -&gt; ContiguousData -&gt; ContiguousData
max :: ContiguousData -&gt; ContiguousData -&gt; ContiguousData
$cmax :: ContiguousData -&gt; ContiguousData -&gt; ContiguousData
&gt;= :: ContiguousData -&gt; ContiguousData -&gt; Bool
$c&gt;= :: ContiguousData -&gt; ContiguousData -&gt; Bool
&gt; :: ContiguousData -&gt; ContiguousData -&gt; Bool
$c&gt; :: ContiguousData -&gt; ContiguousData -&gt; Bool
&lt;= :: ContiguousData -&gt; ContiguousData -&gt; Bool
$c&lt;= :: ContiguousData -&gt; ContiguousData -&gt; Bool
&lt; :: ContiguousData -&gt; ContiguousData -&gt; Bool
$c&lt; :: ContiguousData -&gt; ContiguousData -&gt; Bool
compare :: ContiguousData -&gt; ContiguousData -&gt; Ordering
$ccompare :: ContiguousData -&gt; ContiguousData -&gt; Ordering
$cp1Ord :: Eq ContiguousData
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Ord</span></span></span></span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679034153"><span id="local-6989586621679034155"><span id="local-6989586621679034157"><span class="annot"><span class="annottext">b -&gt; ContiguousData -&gt; ContiguousData
NonEmpty ContiguousData -&gt; ContiguousData
ContiguousData -&gt; ContiguousData -&gt; ContiguousData
(ContiguousData -&gt; ContiguousData -&gt; ContiguousData)
-&gt; (NonEmpty ContiguousData -&gt; ContiguousData)
-&gt; (forall b. Integral b =&gt; b -&gt; ContiguousData -&gt; ContiguousData)
-&gt; Semigroup ContiguousData
forall b. Integral b =&gt; b -&gt; ContiguousData -&gt; ContiguousData
forall a.
(a -&gt; a -&gt; a)
-&gt; (NonEmpty a -&gt; a)
-&gt; (forall b. Integral b =&gt; b -&gt; a -&gt; a)
-&gt; Semigroup a
stimes :: b -&gt; ContiguousData -&gt; ContiguousData
$cstimes :: forall b. Integral b =&gt; b -&gt; ContiguousData -&gt; ContiguousData
sconcat :: NonEmpty ContiguousData -&gt; ContiguousData
$csconcat :: NonEmpty ContiguousData -&gt; ContiguousData
&lt;&gt; :: ContiguousData -&gt; ContiguousData -&gt; ContiguousData
$c&lt;&gt; :: ContiguousData -&gt; ContiguousData -&gt; ContiguousData
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Semigroup</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679034145"><span id="local-6989586621679034147"><span id="local-6989586621679034149"><span class="annot"><span class="annottext">Semigroup ContiguousData
ContiguousData
Semigroup ContiguousData
-&gt; ContiguousData
-&gt; (ContiguousData -&gt; ContiguousData -&gt; ContiguousData)
-&gt; ([ContiguousData] -&gt; ContiguousData)
-&gt; Monoid ContiguousData
[ContiguousData] -&gt; ContiguousData
ContiguousData -&gt; ContiguousData -&gt; ContiguousData
forall a.
Semigroup a -&gt; a -&gt; (a -&gt; a -&gt; a) -&gt; ([a] -&gt; a) -&gt; Monoid a
mconcat :: [ContiguousData] -&gt; ContiguousData
$cmconcat :: [ContiguousData] -&gt; ContiguousData
mappend :: ContiguousData -&gt; ContiguousData -&gt; ContiguousData
$cmappend :: ContiguousData -&gt; ContiguousData -&gt; ContiguousData
mempty :: ContiguousData
$cmempty :: ContiguousData
$cp1Monoid :: Semigroup ContiguousData
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Monoid</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-102"></span><span>
</span><span id="line-103"></span><span class="hs-comment">-- | Change of basis from Map Int Char to ContiguousData</span><span>
</span><span id="line-104"></span><span class="hs-comment">-- TODO: auto derive this w/ @Coercible@</span><span>
</span><span id="line-105"></span><span class="annot"><a href="Main.html#cMap"><span class="hs-identifier hs-type">cMap</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Char</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Char</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Main.html#ContiguousData"><span class="hs-identifier hs-type">ContiguousData</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Main.html#ContiguousData"><span class="hs-identifier hs-type">ContiguousData</span></a></span><span>
</span><span id="line-106"></span><span id="cMap"><span class="annot"><span class="annottext">cMap :: (Map Int Char -&gt; Map Int Char) -&gt; ContiguousData -&gt; ContiguousData
</span><a href="Main.html#cMap"><span class="hs-identifier hs-var hs-var">cMap</span></a></span></span><span> </span><span id="local-6989586621679034142"><span class="annot"><span class="annottext">Map Int Char -&gt; Map Int Char
</span><a href="#local-6989586621679034142"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map Int Char -&gt; ContiguousData
</span><a href="Main.html#ContiguousData"><span class="hs-identifier hs-var">ContiguousData</span></a></span><span> </span><span class="annot"><span class="annottext">(Map Int Char -&gt; ContiguousData)
-&gt; (ContiguousData -&gt; Map Int Char)
-&gt; ContiguousData
-&gt; ContiguousData
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Map Int Char -&gt; Map Int Char
</span><a href="#local-6989586621679034142"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">(Map Int Char -&gt; Map Int Char)
-&gt; (ContiguousData -&gt; Map Int Char)
-&gt; ContiguousData
-&gt; Map Int Char
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ContiguousData -&gt; Map Int Char
</span><a href="Main.html#cData"><span class="hs-identifier hs-var hs-var">cData</span></a></span><span>
</span><span id="line-107"></span><span>
</span><span id="line-108"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679034136"><span id="local-6989586621679034139"><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="annot"><a href="Main.html#ContiguousData"><span class="hs-identifier hs-type">ContiguousData</span></a></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-109"></span><span>  </span><span id="local-6989586621679034134"><span class="annot"><span class="annottext">show :: ContiguousData -&gt; String
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">show</span></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Main.html#ContiguousData"><span class="hs-identifier hs-type">ContiguousData</span></a></span><span> </span><span id="local-6989586621679034132"><span class="annot"><span class="annottext">Map Int Char
</span><a href="#local-6989586621679034132"><span class="hs-identifier hs-var">d</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ShowS
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Char -&gt; Maybe Char -&gt; Char
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'_'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Map Int Char -&gt; Maybe Char
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679034130"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Map Int Char
</span><a href="#local-6989586621679034132"><span class="hs-identifier hs-var">d</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621679034130"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679034130"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-glyph">..</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679034129"><span class="hs-identifier hs-var">highestIndex</span></a></span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><span id="line-110"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-111"></span><span>      </span><span id="local-6989586621679034129"><span class="annot"><span class="annottext">highestIndex :: Int
</span><a href="#local-6989586621679034129"><span class="hs-identifier hs-var hs-var">highestIndex</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Map Int Char -&gt; Maybe ((Int, Char), Map Int Char)
forall k a. Map k a -&gt; Maybe ((k, a), Map k a)
</span><span class="hs-identifier hs-var">maxViewWithKey</span></span><span> </span><span class="annot"><span class="annottext">Map Int Char
</span><a href="#local-6989586621679034132"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-112"></span><span>        </span><span class="annot"><span class="annottext">Maybe ((Int, Char), Map Int Char)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-113"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621679034128"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679034128"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map Int Char
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679034128"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-114"></span><span>
</span><span id="line-115"></span><span>
</span><span id="line-116"></span><span class="hs-comment">-- | File metadata struct</span><span>
</span><span id="line-117"></span><span class="hs-keyword">data</span><span> </span><span id="File"><span class="annot"><a href="Main.html#File"><span class="hs-identifier hs-var">File</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="File"><span class="annot"><a href="Main.html#File"><span class="hs-identifier hs-var">File</span></a></span></span><span>
</span><span id="line-118"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="name"><span class="annot"><span class="annottext">File -&gt; String
</span><a href="Main.html#name"><span class="hs-identifier hs-var hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">,</span><span>
</span><span id="line-119"></span><span>    </span><span id="position"><span class="annot"><span class="annottext">File -&gt; Int
</span><a href="Main.html#position"><span class="hs-identifier hs-var hs-var">position</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span>
</span><span id="line-120"></span><span>    </span><span id="size"><span class="annot"><span class="annottext">File -&gt; Int
</span><a href="Main.html#size"><span class="hs-identifier hs-var hs-var">size</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span>
</span><span id="line-121"></span><span>    </span><span id="unwrittenContents"><span class="annot"><span class="annottext">File -&gt; ContiguousData
</span><a href="Main.html#unwrittenContents"><span class="hs-identifier hs-var hs-var">unwrittenContents</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Main.html#ContiguousData"><span class="hs-identifier hs-type">ContiguousData</span></a></span><span>
</span><span id="line-122"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-123"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679034119"><span id="local-6989586621679034121"><span class="annot"><span class="annottext">File -&gt; File -&gt; Bool
(File -&gt; File -&gt; Bool) -&gt; (File -&gt; File -&gt; Bool) -&gt; Eq File
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: File -&gt; File -&gt; Bool
$c/= :: File -&gt; File -&gt; Bool
== :: File -&gt; File -&gt; Bool
$c== :: File -&gt; File -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679034104"><span id="local-6989586621679034106"><span id="local-6989586621679034108"><span id="local-6989586621679034110"><span id="local-6989586621679034112"><span id="local-6989586621679034114"><span id="local-6989586621679034116"><span class="annot"><span class="annottext">Eq File
Eq File
-&gt; (File -&gt; File -&gt; Ordering)
-&gt; (File -&gt; File -&gt; Bool)
-&gt; (File -&gt; File -&gt; Bool)
-&gt; (File -&gt; File -&gt; Bool)
-&gt; (File -&gt; File -&gt; Bool)
-&gt; (File -&gt; File -&gt; File)
-&gt; (File -&gt; File -&gt; File)
-&gt; Ord File
File -&gt; File -&gt; Bool
File -&gt; File -&gt; Ordering
File -&gt; File -&gt; File
forall a.
Eq a
-&gt; (a -&gt; a -&gt; Ordering)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; Ord a
min :: File -&gt; File -&gt; File
$cmin :: File -&gt; File -&gt; File
max :: File -&gt; File -&gt; File
$cmax :: File -&gt; File -&gt; File
&gt;= :: File -&gt; File -&gt; Bool
$c&gt;= :: File -&gt; File -&gt; Bool
&gt; :: File -&gt; File -&gt; Bool
$c&gt; :: File -&gt; File -&gt; Bool
&lt;= :: File -&gt; File -&gt; Bool
$c&lt;= :: File -&gt; File -&gt; Bool
&lt; :: File -&gt; File -&gt; Bool
$c&lt; :: File -&gt; File -&gt; Bool
compare :: File -&gt; File -&gt; Ordering
$ccompare :: File -&gt; File -&gt; Ordering
$cp1Ord :: Eq File
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Ord</span></span></span></span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679034098"><span id="local-6989586621679034100"><span id="local-6989586621679034102"><span class="annot"><span class="annottext">Int -&gt; File -&gt; ShowS
[File] -&gt; ShowS
File -&gt; String
(Int -&gt; File -&gt; ShowS)
-&gt; (File -&gt; String) -&gt; ([File] -&gt; ShowS) -&gt; Show File
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [File] -&gt; ShowS
$cshowList :: [File] -&gt; ShowS
show :: File -&gt; String
$cshow :: File -&gt; String
showsPrec :: Int -&gt; File -&gt; ShowS
$cshowsPrec :: Int -&gt; File -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-124"></span><span>
</span><span id="line-125"></span><span class="hs-keyword">type</span><span> </span><span id="FileName"><span class="annot"><a href="Main.html#FileName"><span class="hs-identifier hs-var">FileName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-126"></span><span>
</span><span id="line-127"></span><span class="hs-comment">-- | Struct to hold mapping of disk position -&gt; file at that position</span><span>
</span><span id="line-128"></span><span class="hs-keyword">type</span><span> </span><span id="ReverseLookup"><span class="annot"><a href="Main.html#ReverseLookup"><span class="hs-identifier hs-var">ReverseLookup</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="annot"><a href="Main.html#File"><span class="hs-identifier hs-type">File</span></a></span><span>
</span><span id="line-129"></span><span>
</span><span id="line-130"></span><span class="hs-comment">-- | Struct for filesystem metadata</span><span>
</span><span id="line-131"></span><span class="hs-keyword">data</span><span> </span><span id="FileSystem"><span class="annot"><a href="Main.html#FileSystem"><span class="hs-identifier hs-var">FileSystem</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="FileSystem"><span class="annot"><a href="Main.html#FileSystem"><span class="hs-identifier hs-var">FileSystem</span></a></span></span><span>
</span><span id="line-132"></span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- | Set of files on disk</span><span>
</span><span id="line-133"></span><span>    </span><span id="files"><span class="annot"><span class="annottext">FileSystem -&gt; Set File
</span><a href="Main.html#files"><span class="hs-identifier hs-var hs-var">files</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><a href="Main.html#File"><span class="hs-identifier hs-type">File</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-134"></span><span>    </span><span class="hs-comment">-- | Set of filenames on disk</span><span>
</span><span id="line-135"></span><span>    </span><span id="fileNames"><span class="annot"><span class="annottext">FileSystem -&gt; Set String
</span><a href="Main.html#fileNames"><span class="hs-identifier hs-var hs-var">fileNames</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><a href="Main.html#FileName"><span class="hs-identifier hs-type">FileName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-136"></span><span>    </span><span class="hs-comment">-- | Map of disk position -&gt; file</span><span>
</span><span id="line-137"></span><span>    </span><span id="freverseLookup"><span class="annot"><span class="annottext">FileSystem -&gt; ReverseLookup
</span><a href="Main.html#freverseLookup"><span class="hs-identifier hs-var hs-var">freverseLookup</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Main.html#ReverseLookup"><span class="hs-identifier hs-type">ReverseLookup</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-138"></span><span>    </span><span class="hs-comment">-- | Index of lowest free position (we don't support delete so no fragmentation)</span><span>
</span><span id="line-139"></span><span>    </span><span id="freeIndex"><span class="annot"><span class="annottext">FileSystem -&gt; Int
</span><a href="Main.html#freeIndex"><span class="hs-identifier hs-var hs-var">freeIndex</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span>
</span><span id="line-140"></span><span>    </span><span class="hs-comment">-- | Map of filename to mutable read handles</span><span>
</span><span id="line-141"></span><span>    </span><span id="filesToRead"><span class="annot"><span class="annottext">FileSystem -&gt; Map String (IORef ReadHandle)
</span><a href="Main.html#filesToRead"><span class="hs-identifier hs-var hs-var">filesToRead</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IORef</span></span><span> </span><span class="annot"><a href="Main.html#ReadHandle"><span class="hs-identifier hs-type">ReadHandle</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-142"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-143"></span><span>
</span><span id="line-144"></span><span class="hs-comment">-- | Helper function to make code more understandable for imperative people</span><span>
</span><span id="line-145"></span><span id="local-6989586621679034299"><span class="annot"><a href="Main.html#continue"><span class="hs-identifier hs-type">continue</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Applicative</span></span><span> </span><span class="annot"><a href="#local-6989586621679034299"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679034299"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-146"></span><span id="continue"><span class="annot"><span class="annottext">continue :: f ()
</span><a href="Main.html#continue"><span class="hs-identifier hs-var hs-var">continue</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; f ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-147"></span><span>
</span><span id="line-148"></span><span class="hs-comment">-- | `createFile` has access to an environment that has access to a disk, and returns a nullable FileSystem</span><span>
</span><span id="line-149"></span><span id="local-6989586621679034222"><span id="local-6989586621679034223"><span class="annot"><a href="Main.html#createFile"><span class="hs-identifier hs-type">createFile</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-150"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679034223"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Main.html#Disk"><span class="hs-identifier hs-type">Disk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679034222"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="annot"><a href="#local-6989586621679034222"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679034223"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadPlus</span></span><span> </span><span class="annot"><a href="#local-6989586621679034223"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-151"></span><span>  </span><span class="annot"><a href="Main.html#FileSystem"><span class="hs-identifier hs-type">FileSystem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-152"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-153"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-154"></span><span>  </span><span class="annot"><a href="#local-6989586621679034223"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Main.html#FileSystem"><span class="hs-identifier hs-type">FileSystem</span></a></span></span></span><span>
</span><span id="line-155"></span><span id="createFile"><span class="annot"><span class="annottext">createFile :: FileSystem -&gt; String -&gt; String -&gt; m FileSystem
</span><a href="Main.html#createFile"><span class="hs-identifier hs-var hs-var">createFile</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Main.html#FileSystem"><span class="hs-identifier hs-type">FileSystem</span></a></span><span> </span><span id="local-6989586621679034088"><span class="annot"><span class="annottext">Set File
</span><a href="#local-6989586621679034088"><span class="hs-identifier hs-var">files</span></a></span></span><span> </span><span id="local-6989586621679034087"><span class="annot"><span class="annottext">Set String
</span><a href="#local-6989586621679034087"><span class="hs-identifier hs-var">fileNames</span></a></span></span><span> </span><span id="local-6989586621679034086"><span class="annot"><span class="annottext">ReverseLookup
</span><a href="#local-6989586621679034086"><span class="hs-identifier hs-var">rl</span></a></span></span><span> </span><span id="local-6989586621679034085"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679034085"><span class="hs-identifier hs-var">freeIndex</span></a></span></span><span> </span><span id="local-6989586621679034084"><span class="annot"><span class="annottext">Map String (IORef ReadHandle)
</span><a href="#local-6989586621679034084"><span class="hs-identifier hs-var">ftr</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679034083"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679034083"><span class="hs-identifier hs-var">filename</span></a></span></span><span> </span><span id="local-6989586621679034082"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679034082"><span class="hs-identifier hs-var">fcontents</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-156"></span><span>  </span><span id="local-6989586621679034081"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679034081"><span class="hs-identifier hs-var">disk</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m a
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">ask</span></span><span> </span><span class="hs-comment">-- ask for disk from environment</span><span>
</span><span id="line-157"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679034080"><span class="annot"><span class="annottext">contentsMap :: ContiguousData
</span><a href="#local-6989586621679034080"><span class="hs-identifier hs-var hs-var">contentsMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map Int Char -&gt; ContiguousData
</span><a href="Main.html#ContiguousData"><span class="hs-identifier hs-var">ContiguousData</span></a></span><span> </span><span class="annot"><span class="annottext">(Map Int Char -&gt; ContiguousData) -&gt; Map Int Char -&gt; ContiguousData
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(Int, Char)] -&gt; Map Int Char
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.fromList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Int] -&gt; String -&gt; [(Int, Char)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679034082"><span class="hs-identifier hs-var">fcontents</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-158"></span><span>      </span><span id="local-6989586621679034078"><span class="annot"><span class="annottext">newFile :: File
</span><a href="#local-6989586621679034078"><span class="hs-identifier hs-var hs-var">newFile</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Int -&gt; Int -&gt; ContiguousData -&gt; File
</span><a href="Main.html#File"><span class="hs-identifier hs-var">File</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679034083"><span class="hs-identifier hs-var">filename</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679034085"><span class="hs-identifier hs-var">freeIndex</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679034082"><span class="hs-identifier hs-var">fcontents</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ContiguousData
</span><a href="#local-6989586621679034080"><span class="hs-identifier hs-var">contentsMap</span></a></span><span>
</span><span id="line-159"></span><span>
</span><span id="line-160"></span><span>  </span><span class="hs-comment">-- guard: if any bool fails, return Nothing</span><span>
</span><span id="line-161"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; m ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">File -&gt; Int
</span><a href="Main.html#position"><span class="hs-identifier hs-var hs-var">position</span></a></span><span> </span><span class="annot"><span class="annottext">File
</span><a href="#local-6989586621679034078"><span class="hs-identifier hs-var">newFile</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">File -&gt; Int
</span><a href="Main.html#size"><span class="hs-identifier hs-var hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">File
</span><a href="#local-6989586621679034078"><span class="hs-identifier hs-var">newFile</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Int
forall a. Disk a =&gt; a -&gt; Int
</span><a href="Main.html#dlength"><span class="hs-identifier hs-var">dlength</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679034081"><span class="hs-identifier hs-var">disk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-162"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; m ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">File -&gt; Int
</span><a href="Main.html#position"><span class="hs-identifier hs-var hs-var">position</span></a></span><span> </span><span class="annot"><span class="annottext">File
</span><a href="#local-6989586621679034078"><span class="hs-identifier hs-var">newFile</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">File -&gt; Int
</span><a href="Main.html#size"><span class="hs-identifier hs-var hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">File
</span><a href="#local-6989586621679034078"><span class="hs-identifier hs-var">newFile</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-163"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; m ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Set String -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><span class="hs-identifier hs-var">Set.member</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679034083"><span class="hs-identifier hs-var">filename</span></a></span><span> </span><span class="annot"><span class="annottext">Set String
</span><a href="#local-6989586621679034087"><span class="hs-identifier hs-var">fileNames</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-164"></span><span>
</span><span id="line-165"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679034072"><span class="annot"><span class="annottext">newFiles :: Set File
</span><a href="#local-6989586621679034072"><span class="hs-identifier hs-var hs-var">newFiles</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">File -&gt; Set File -&gt; Set File
forall a. Ord a =&gt; a -&gt; Set a -&gt; Set a
</span><span class="hs-identifier hs-var">Set.insert</span></span><span> </span><span class="annot"><span class="annottext">File
</span><a href="#local-6989586621679034078"><span class="hs-identifier hs-var">newFile</span></a></span><span> </span><span class="annot"><span class="annottext">Set File
</span><a href="#local-6989586621679034088"><span class="hs-identifier hs-var">files</span></a></span><span>
</span><span id="line-166"></span><span>      </span><span id="local-6989586621679034070"><span class="annot"><span class="annottext">newRl :: ReverseLookup
</span><a href="#local-6989586621679034070"><span class="hs-identifier hs-var hs-var">newRl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ReverseLookup -&gt; Int -&gt; ReverseLookup)
-&gt; ReverseLookup -&gt; [Int] -&gt; ReverseLookup
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679034068"><span class="annot"><span class="annottext">ReverseLookup
</span><a href="#local-6989586621679034068"><span class="hs-identifier hs-var">rlAccum</span></a></span></span><span> </span><span id="local-6989586621679034067"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679034067"><span class="hs-identifier hs-var">index</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int -&gt; File -&gt; ReverseLookup -&gt; ReverseLookup
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.insert</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679034067"><span class="hs-identifier hs-var">index</span></a></span><span> </span><span class="annot"><span class="annottext">File
</span><a href="#local-6989586621679034078"><span class="hs-identifier hs-var">newFile</span></a></span><span> </span><span class="annot"><span class="annottext">ReverseLookup
</span><a href="#local-6989586621679034068"><span class="hs-identifier hs-var">rlAccum</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ReverseLookup
</span><a href="#local-6989586621679034086"><span class="hs-identifier hs-var">rl</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679034085"><span class="hs-identifier hs-var">freeIndex</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679034085"><span class="hs-identifier hs-var">freeIndex</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679034065"><span class="hs-identifier hs-var">newFreeIndex</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span>
</span><span id="line-167"></span><span>      </span><span id="local-6989586621679034064"><span class="annot"><span class="annottext">newFileNames :: Set String
</span><a href="#local-6989586621679034064"><span class="hs-identifier hs-var hs-var">newFileNames</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Set String -&gt; Set String
forall a. Ord a =&gt; a -&gt; Set a -&gt; Set a
</span><span class="hs-identifier hs-var">Set.insert</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679034083"><span class="hs-identifier hs-var">filename</span></a></span><span> </span><span class="annot"><span class="annottext">Set String
</span><a href="#local-6989586621679034087"><span class="hs-identifier hs-var">fileNames</span></a></span><span>
</span><span id="line-168"></span><span>      </span><span id="local-6989586621679034065"><span class="annot"><span class="annottext">newFreeIndex :: Int
</span><a href="#local-6989586621679034065"><span class="hs-identifier hs-var hs-var">newFreeIndex</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679034085"><span class="hs-identifier hs-var">freeIndex</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679034082"><span class="hs-identifier hs-var">fcontents</span></a></span><span>
</span><span id="line-169"></span><span>
</span><span id="line-170"></span><span>  </span><span class="hs-identifier">return</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set File
-&gt; Set String
-&gt; ReverseLookup
-&gt; Int
-&gt; Map String (IORef ReadHandle)
-&gt; FileSystem
</span><a href="Main.html#FileSystem"><span class="hs-identifier hs-var">FileSystem</span></a></span><span> </span><span class="annot"><span class="annottext">Set File
</span><a href="#local-6989586621679034072"><span class="hs-identifier hs-var">newFiles</span></a></span><span> </span><span class="annot"><span class="annottext">Set String
</span><a href="#local-6989586621679034064"><span class="hs-identifier hs-var">newFileNames</span></a></span><span> </span><span class="annot"><span class="annottext">ReverseLookup
</span><a href="#local-6989586621679034070"><span class="hs-identifier hs-var">newRl</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679034065"><span class="hs-identifier hs-var">newFreeIndex</span></a></span><span> </span><span class="annot"><span class="annottext">Map String (IORef ReadHandle)
</span><a href="#local-6989586621679034084"><span class="hs-identifier hs-var">ftr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-171"></span><span>
</span><span id="line-172"></span><span class="hs-comment">-- | `onDiskSpin` also has access to a disk env, and has access to IO</span><span>
</span><span id="line-173"></span><span id="local-6989586621679034218"><span id="local-6989586621679034219"><span class="annot"><a href="Main.html#onDiskSpin"><span class="hs-identifier hs-type">onDiskSpin</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-174"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679034219"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Main.html#Disk"><span class="hs-identifier hs-type">Disk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679034218"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="annot"><a href="#local-6989586621679034218"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679034219"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679034219"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-175"></span><span>  </span><span class="annot"><a href="Main.html#FileSystem"><span class="hs-identifier hs-type">FileSystem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-176"></span><span>  </span><span class="annot"><a href="#local-6989586621679034219"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Main.html#FileSystem"><span class="hs-identifier hs-type">FileSystem</span></a></span></span></span><span>
</span><span id="line-177"></span><span id="onDiskSpin"><span class="annot"><span class="annottext">onDiskSpin :: FileSystem -&gt; m FileSystem
</span><a href="Main.html#onDiskSpin"><span class="hs-identifier hs-var hs-var">onDiskSpin</span></a></span></span><span> </span><span id="local-6989586621679034062"><span class="annot"><span class="annottext">fs :: FileSystem
</span><a href="#local-6989586621679034062"><span class="hs-identifier hs-var">fs</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Main.html#FileSystem"><span class="hs-identifier hs-type">FileSystem</span></a></span><span> </span><span id="local-6989586621679034061"><span class="annot"><span class="annottext">Set File
</span><a href="#local-6989586621679034061"><span class="hs-identifier hs-var">files</span></a></span></span><span> </span><span id="local-6989586621679034060"><span class="annot"><span class="annottext">Set String
</span><a href="#local-6989586621679034060"><span class="hs-identifier hs-var">fileNames</span></a></span></span><span> </span><span id="local-6989586621679034059"><span class="annot"><span class="annottext">ReverseLookup
</span><a href="#local-6989586621679034059"><span class="hs-identifier hs-var">rl</span></a></span></span><span> </span><span id="local-6989586621679034058"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679034058"><span class="hs-identifier hs-var">freeIndex</span></a></span></span><span> </span><span id="local-6989586621679034057"><span class="annot"><span class="annottext">Map String (IORef ReadHandle)
</span><a href="#local-6989586621679034057"><span class="hs-identifier hs-var">readHandles</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ContT FileSystem m FileSystem -&gt; m FileSystem
forall (m :: * -&gt; *) r. Monad m =&gt; ContT r m r -&gt; m r
</span><span class="hs-identifier hs-var">evalContT</span></span><span> </span><span class="annot"><span class="annottext">(ContT FileSystem m FileSystem -&gt; m FileSystem)
-&gt; (((FileSystem -&gt; ContT FileSystem m File)
     -&gt; ContT FileSystem m FileSystem)
    -&gt; ContT FileSystem m FileSystem)
-&gt; ((FileSystem -&gt; ContT FileSystem m File)
    -&gt; ContT FileSystem m FileSystem)
-&gt; m FileSystem
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">((FileSystem -&gt; ContT FileSystem m File)
 -&gt; ContT FileSystem m FileSystem)
-&gt; ContT FileSystem m FileSystem
forall k a (r :: k) (m :: k -&gt; *) b.
((a -&gt; ContT r m b) -&gt; ContT r m a) -&gt; ContT r m a
</span><span class="hs-identifier hs-var">callCC</span></span><span> </span><span class="annot"><span class="annottext">(((FileSystem -&gt; ContT FileSystem m File)
  -&gt; ContT FileSystem m FileSystem)
 -&gt; m FileSystem)
-&gt; ((FileSystem -&gt; ContT FileSystem m File)
    -&gt; ContT FileSystem m FileSystem)
-&gt; m FileSystem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679034056"><span class="annot"><span class="annottext">FileSystem -&gt; ContT FileSystem m File
</span><a href="#local-6989586621679034056"><span class="hs-identifier hs-var">ret</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-178"></span><span>  </span><span id="local-6989586621679034055"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679034055"><span class="hs-identifier hs-var">disk</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ContT FileSystem m a
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-179"></span><span>  </span><span id="local-6989586621679034054"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679034054"><span class="hs-identifier hs-var">curPos</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO Int -&gt; ContT FileSystem m Int
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO Int -&gt; ContT FileSystem m Int)
-&gt; IO Int -&gt; ContT FileSystem m Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; IO Int
forall a. Disk a =&gt; a -&gt; IO Int
</span><a href="Main.html#current_position"><span class="hs-identifier hs-var">current_position</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679034055"><span class="hs-identifier hs-var">disk</span></a></span><span>
</span><span id="line-180"></span><span>
</span><span id="line-181"></span><span>  </span><span id="local-6989586621679034053"><span class="annot"><span class="annottext">File
</span><a href="#local-6989586621679034053"><span class="hs-identifier hs-var">file</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ContT FileSystem m File
-&gt; (File -&gt; ContT FileSystem m File)
-&gt; Maybe File
-&gt; ContT FileSystem m File
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FileSystem -&gt; ContT FileSystem m File
</span><a href="#local-6989586621679034056"><span class="hs-identifier hs-var">ret</span></a></span><span> </span><span class="annot"><span class="annottext">FileSystem
</span><a href="#local-6989586621679034062"><span class="hs-identifier hs-var">fs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">File -&gt; ContT FileSystem m File
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; ReverseLookup -&gt; Maybe File
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679034054"><span class="hs-identifier hs-var">curPos</span></a></span><span> </span><span class="annot"><span class="annottext">ReverseLookup
</span><a href="#local-6989586621679034059"><span class="hs-identifier hs-var">rl</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- break early w/ callCC if there's no file at the position</span><span>
</span><span id="line-182"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Map Int Char -&gt; Maybe Char
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679034054"><span class="hs-identifier hs-var">curPos</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">File -&gt; Int
</span><a href="Main.html#position"><span class="hs-identifier hs-var hs-var">position</span></a></span><span> </span><span class="annot"><span class="annottext">File
</span><a href="#local-6989586621679034053"><span class="hs-identifier hs-var">file</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ContiguousData -&gt; Map Int Char
</span><a href="Main.html#cData"><span class="hs-identifier hs-var hs-var">cData</span></a></span><span> </span><span class="annot"><span class="annottext">(ContiguousData -&gt; Map Int Char) -&gt; ContiguousData -&gt; Map Int Char
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">File -&gt; ContiguousData
</span><a href="Main.html#unwrittenContents"><span class="hs-identifier hs-var hs-var">unwrittenContents</span></a></span><span> </span><span class="annot"><span class="annottext">File
</span><a href="#local-6989586621679034053"><span class="hs-identifier hs-var">file</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-183"></span><span>    </span><span class="annot"><span class="annottext">Maybe Char
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ContT FileSystem m ()
forall (f :: * -&gt; *). Applicative f =&gt; f ()
</span><a href="Main.html#continue"><span class="hs-identifier hs-var">continue</span></a></span><span>
</span><span id="line-184"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679034051"><span class="annot"><span class="annottext">Char
</span><a href="#local-6989586621679034051"><span class="hs-identifier hs-var">char</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; ContT FileSystem m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; ContT FileSystem m ()) -&gt; IO () -&gt; ContT FileSystem m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Char -&gt; IO ()
forall a. Disk a =&gt; a -&gt; Char -&gt; IO ()
</span><a href="Main.html#write"><span class="hs-identifier hs-var">write</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679034055"><span class="hs-identifier hs-var">disk</span></a></span><span> </span><span class="annot"><span class="annottext">Char
</span><a href="#local-6989586621679034051"><span class="hs-identifier hs-var">char</span></a></span><span>
</span><span id="line-185"></span><span>
</span><span id="line-186"></span><span>  </span><span id="local-6989586621679034050"><span class="annot"><span class="annottext">Char
</span><a href="#local-6989586621679034050"><span class="hs-identifier hs-var">charAtCurPos</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO Char -&gt; ContT FileSystem m Char
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO Char -&gt; ContT FileSystem m Char)
-&gt; IO Char -&gt; ContT FileSystem m Char
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; IO Char
forall a. Disk a =&gt; a -&gt; IO Char
</span><a href="Main.html#read"><span class="hs-identifier hs-var">read</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679034055"><span class="hs-identifier hs-var">disk</span></a></span><span>
</span><span id="line-187"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679034049"><span class="annot"><span class="annottext">maybeReadHandle :: Maybe (IORef ReadHandle)
</span><a href="#local-6989586621679034049"><span class="hs-identifier hs-var hs-var">maybeReadHandle</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Map String (IORef ReadHandle) -&gt; Maybe (IORef ReadHandle)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">File -&gt; String
</span><a href="Main.html#name"><span class="hs-identifier hs-var hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">File
</span><a href="#local-6989586621679034053"><span class="hs-identifier hs-var">file</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map String (IORef ReadHandle)
</span><a href="#local-6989586621679034057"><span class="hs-identifier hs-var">readHandles</span></a></span><span>
</span><span id="line-188"></span><span>  </span><span class="annot"><span class="annottext">IO (Maybe ()) -&gt; ContT FileSystem m (Maybe ())
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Maybe ()) -&gt; ContT FileSystem m (Maybe ()))
-&gt; IO (Maybe ()) -&gt; ContT FileSystem m (Maybe ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(IORef ReadHandle -&gt; IO ())
-&gt; Maybe (IORef ReadHandle) -&gt; IO (Maybe ())
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IORef ReadHandle -&gt; (ReadHandle -&gt; ReadHandle) -&gt; IO ()
forall a. IORef a -&gt; (a -&gt; a) -&gt; IO ()
</span><span class="hs-operator hs-var">`modifyIORef'`</span></span><span> </span><span class="annot"><span class="annottext">File -&gt; Int -&gt; Char -&gt; ReadHandle -&gt; ReadHandle
</span><a href="#local-6989586621679034047"><span class="hs-identifier hs-var">updateHandle</span></a></span><span> </span><span class="annot"><span class="annottext">File
</span><a href="#local-6989586621679034053"><span class="hs-identifier hs-var">file</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679034054"><span class="hs-identifier hs-var">curPos</span></a></span><span> </span><span class="annot"><span class="annottext">Char
</span><a href="#local-6989586621679034050"><span class="hs-identifier hs-var">charAtCurPos</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe (IORef ReadHandle)
</span><a href="#local-6989586621679034049"><span class="hs-identifier hs-var">maybeReadHandle</span></a></span><span> </span><span class="hs-comment">-- update handle if handle is present</span><span>
</span><span id="line-189"></span><span>
</span><span id="line-190"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679034046"><span class="annot"><span class="annottext">newFile :: File
</span><a href="#local-6989586621679034046"><span class="hs-identifier hs-var hs-var">newFile</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Int -&gt; Int -&gt; ContiguousData -&gt; File
</span><a href="Main.html#File"><span class="hs-identifier hs-var">File</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">File -&gt; String
</span><a href="Main.html#name"><span class="hs-identifier hs-var hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">File
</span><a href="#local-6989586621679034053"><span class="hs-identifier hs-var">file</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">File -&gt; Int
</span><a href="Main.html#position"><span class="hs-identifier hs-var hs-var">position</span></a></span><span> </span><span class="annot"><span class="annottext">File
</span><a href="#local-6989586621679034053"><span class="hs-identifier hs-var">file</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">File -&gt; Int
</span><a href="Main.html#size"><span class="hs-identifier hs-var hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">File
</span><a href="#local-6989586621679034053"><span class="hs-identifier hs-var">file</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Map Int Char -&gt; Map Int Char) -&gt; ContiguousData -&gt; ContiguousData
</span><a href="Main.html#cMap"><span class="hs-identifier hs-var">cMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Map Int Char -&gt; Map Int Char
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.delete</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679034054"><span class="hs-identifier hs-var">curPos</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">File -&gt; Int
</span><a href="Main.html#position"><span class="hs-identifier hs-var hs-var">position</span></a></span><span> </span><span class="annot"><span class="annottext">File
</span><a href="#local-6989586621679034053"><span class="hs-identifier hs-var">file</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">File -&gt; ContiguousData
</span><a href="Main.html#unwrittenContents"><span class="hs-identifier hs-var hs-var">unwrittenContents</span></a></span><span> </span><span class="annot"><span class="annottext">File
</span><a href="#local-6989586621679034053"><span class="hs-identifier hs-var">file</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-191"></span><span>      </span><span id="local-6989586621679034044"><span class="annot"><span class="annottext">newFiles :: Set File
</span><a href="#local-6989586621679034044"><span class="hs-identifier hs-var hs-var">newFiles</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">File -&gt; Set File -&gt; Set File
forall a. Ord a =&gt; a -&gt; Set a -&gt; Set a
</span><span class="hs-identifier hs-var">Set.insert</span></span><span> </span><span class="annot"><span class="annottext">File
</span><a href="#local-6989586621679034046"><span class="hs-identifier hs-var">newFile</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">File -&gt; Set File -&gt; Set File
forall a. Ord a =&gt; a -&gt; Set a -&gt; Set a
</span><span class="hs-identifier hs-var">Set.delete</span></span><span> </span><span class="annot"><span class="annottext">File
</span><a href="#local-6989586621679034053"><span class="hs-identifier hs-var">file</span></a></span><span> </span><span class="annot"><span class="annottext">Set File
</span><a href="#local-6989586621679034061"><span class="hs-identifier hs-var">files</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-192"></span><span>      </span><span id="local-6989586621679034042"><span class="annot"><span class="annottext">newRl :: ReverseLookup
</span><a href="#local-6989586621679034042"><span class="hs-identifier hs-var hs-var">newRl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; File -&gt; ReverseLookup -&gt; ReverseLookup
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.insert</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679034054"><span class="hs-identifier hs-var">curPos</span></a></span><span> </span><span class="annot"><span class="annottext">File
</span><a href="#local-6989586621679034046"><span class="hs-identifier hs-var">newFile</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; ReverseLookup -&gt; ReverseLookup
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.delete</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679034054"><span class="hs-identifier hs-var">curPos</span></a></span><span> </span><span class="annot"><span class="annottext">ReverseLookup
</span><a href="#local-6989586621679034059"><span class="hs-identifier hs-var">rl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-193"></span><span>      </span><span id="local-6989586621679034041"><span class="annot"><span class="annottext">newFileNames :: Set String
</span><a href="#local-6989586621679034041"><span class="hs-identifier hs-var hs-var">newFileNames</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Set String -&gt; Set String
forall a. Ord a =&gt; a -&gt; Set a -&gt; Set a
</span><span class="hs-identifier hs-var">Set.insert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">File -&gt; String
</span><a href="Main.html#name"><span class="hs-identifier hs-var hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">File
</span><a href="#local-6989586621679034053"><span class="hs-identifier hs-var">file</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Set String
</span><a href="#local-6989586621679034060"><span class="hs-identifier hs-var">fileNames</span></a></span><span>
</span><span id="line-194"></span><span>  </span><span class="hs-identifier">return</span><span> </span><span class="hs-operator">$</span><span> </span><span class="annot"><span class="annottext">Set File
-&gt; Set String
-&gt; ReverseLookup
-&gt; Int
-&gt; Map String (IORef ReadHandle)
-&gt; FileSystem
</span><a href="Main.html#FileSystem"><span class="hs-identifier hs-var">FileSystem</span></a></span><span> </span><span class="annot"><span class="annottext">Set File
</span><a href="#local-6989586621679034044"><span class="hs-identifier hs-var">newFiles</span></a></span><span> </span><span class="annot"><span class="annottext">Set String
</span><a href="#local-6989586621679034041"><span class="hs-identifier hs-var">newFileNames</span></a></span><span> </span><span class="annot"><span class="annottext">ReverseLookup
</span><a href="#local-6989586621679034042"><span class="hs-identifier hs-var">newRl</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679034058"><span class="hs-identifier hs-var">freeIndex</span></a></span><span> </span><span class="annot"><span class="annottext">Map String (IORef ReadHandle)
</span><a href="#local-6989586621679034057"><span class="hs-identifier hs-var">readHandles</span></a></span><span>
</span><span id="line-195"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-196"></span><span>    </span><span class="annot"><a href="#local-6989586621679034047"><span class="hs-identifier hs-type">updateHandle</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Main.html#File"><span class="hs-identifier hs-type">File</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Char</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Main.html#ReadHandle"><span class="hs-identifier hs-type">ReadHandle</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Main.html#ReadHandle"><span class="hs-identifier hs-type">ReadHandle</span></a></span><span>
</span><span id="line-197"></span><span>    </span><span id="local-6989586621679034047"><span class="annot"><span class="annottext">updateHandle :: File -&gt; Int -&gt; Char -&gt; ReadHandle -&gt; ReadHandle
</span><a href="#local-6989586621679034047"><span class="hs-identifier hs-var hs-var">updateHandle</span></a></span></span><span> </span><span id="local-6989586621679034040"><span class="annot"><span class="annottext">File
</span><a href="#local-6989586621679034040"><span class="hs-identifier hs-var">file</span></a></span></span><span> </span><span id="local-6989586621679034039"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679034039"><span class="hs-identifier hs-var">curPosition</span></a></span></span><span> </span><span id="local-6989586621679034038"><span class="annot"><span class="annottext">Char
</span><a href="#local-6989586621679034038"><span class="hs-identifier hs-var">char</span></a></span></span><span> </span><span id="local-6989586621679034037"><span class="annot"><span class="annottext">ReadHandle
</span><a href="#local-6989586621679034037"><span class="hs-identifier hs-var">handle</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-198"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679034036"><span class="annot"><span class="annottext">newContents :: ContiguousData
</span><a href="#local-6989586621679034036"><span class="hs-identifier hs-var hs-var">newContents</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Map Int Char -&gt; Map Int Char) -&gt; ContiguousData -&gt; ContiguousData
</span><a href="Main.html#cMap"><span class="hs-identifier hs-var">cMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Char -&gt; Map Int Char -&gt; Map Int Char
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.insert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679034039"><span class="hs-identifier hs-var">curPosition</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">File -&gt; Int
</span><a href="Main.html#position"><span class="hs-identifier hs-var hs-var">position</span></a></span><span> </span><span class="annot"><span class="annottext">File
</span><a href="#local-6989586621679034040"><span class="hs-identifier hs-var">file</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Char
</span><a href="#local-6989586621679034038"><span class="hs-identifier hs-var">char</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ReadHandle -&gt; ContiguousData
</span><a href="Main.html#rcontents"><span class="hs-identifier hs-var hs-var">rcontents</span></a></span><span> </span><span class="annot"><span class="annottext">ReadHandle
</span><a href="#local-6989586621679034037"><span class="hs-identifier hs-var">handle</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-199"></span><span>          </span><span id="local-6989586621679034034"><span class="annot"><span class="annottext">ready :: Bool
</span><a href="#local-6989586621679034034"><span class="hs-identifier hs-var hs-var">ready</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Int, Char)] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map Int Char -&gt; [(Int, Char)]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">Map.toList</span></span><span> </span><span class="annot"><span class="annottext">(Map Int Char -&gt; [(Int, Char)])
-&gt; (ContiguousData -&gt; Map Int Char)
-&gt; ContiguousData
-&gt; [(Int, Char)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ContiguousData -&gt; Map Int Char
</span><a href="Main.html#cData"><span class="hs-identifier hs-var hs-var">cData</span></a></span><span> </span><span class="annot"><span class="annottext">(ContiguousData -&gt; [(Int, Char)])
-&gt; ContiguousData -&gt; [(Int, Char)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ReadHandle -&gt; ContiguousData
</span><a href="Main.html#rcontents"><span class="hs-identifier hs-var hs-var">rcontents</span></a></span><span> </span><span class="annot"><span class="annottext">ReadHandle
</span><a href="#local-6989586621679034037"><span class="hs-identifier hs-var">handle</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">File -&gt; Int
</span><a href="Main.html#size"><span class="hs-identifier hs-var hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">File
</span><a href="#local-6989586621679034040"><span class="hs-identifier hs-var">file</span></a></span><span>
</span><span id="line-200"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">ContiguousData -&gt; Bool -&gt; ReadHandle
</span><a href="Main.html#ReadHandle"><span class="hs-identifier hs-var">ReadHandle</span></a></span><span> </span><span class="annot"><span class="annottext">ContiguousData
</span><a href="#local-6989586621679034036"><span class="hs-identifier hs-var">newContents</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679034034"><span class="hs-identifier hs-var">ready</span></a></span><span>
</span><span id="line-201"></span><span>
</span><span id="line-202"></span><span class="hs-comment">-- | Immutable handle type. Usually passed in an IORef for mutability</span><span>
</span><span id="line-203"></span><span class="hs-keyword">data</span><span> </span><span id="ReadHandle"><span class="annot"><a href="Main.html#ReadHandle"><span class="hs-identifier hs-var">ReadHandle</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ReadHandle"><span class="annot"><a href="Main.html#ReadHandle"><span class="hs-identifier hs-var">ReadHandle</span></a></span></span><span> </span><span class="hs-special">{</span><span id="rcontents"><span class="annot"><span class="annottext">ReadHandle -&gt; ContiguousData
</span><a href="Main.html#rcontents"><span class="hs-identifier hs-var hs-var">rcontents</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Main.html#ContiguousData"><span class="hs-identifier hs-type">ContiguousData</span></a></span><span class="hs-special">,</span><span> </span><span id="isReady"><span class="annot"><span class="annottext">ReadHandle -&gt; Bool
</span><a href="Main.html#isReady"><span class="hs-identifier hs-var hs-var">isReady</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679034025"><span id="local-6989586621679034027"><span id="local-6989586621679034029"><span class="annot"><span class="annottext">Int -&gt; ReadHandle -&gt; ShowS
[ReadHandle] -&gt; ShowS
ReadHandle -&gt; String
(Int -&gt; ReadHandle -&gt; ShowS)
-&gt; (ReadHandle -&gt; String)
-&gt; ([ReadHandle] -&gt; ShowS)
-&gt; Show ReadHandle
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [ReadHandle] -&gt; ShowS
$cshowList :: [ReadHandle] -&gt; ShowS
show :: ReadHandle -&gt; String
$cshow :: ReadHandle -&gt; String
showsPrec :: Int -&gt; ReadHandle -&gt; ShowS
$cshowsPrec :: Int -&gt; ReadHandle -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-204"></span><span>
</span><span id="line-205"></span><span class="hs-comment">-- | `readFile` has an internal modifyable FileSystem state, has IO, and returns a reference to a ReadHandle</span><span>
</span><span id="line-206"></span><span id="local-6989586621679034213"><span class="annot"><a href="Main.html#readFile"><span class="hs-identifier hs-type">readFile</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-207"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679034213"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadState</span></span><span> </span><span class="annot"><a href="Main.html#FileSystem"><span class="hs-identifier hs-type">FileSystem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679034213"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679034213"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-208"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-209"></span><span>  </span><span class="annot"><a href="#local-6989586621679034213"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IORef</span></span><span> </span><span class="annot"><a href="Main.html#ReadHandle"><span class="hs-identifier hs-type">ReadHandle</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-210"></span><span id="readFile"><span class="annot"><span class="annottext">readFile :: String -&gt; m (IORef ReadHandle)
</span><a href="Main.html#readFile"><span class="hs-identifier hs-var hs-var">readFile</span></a></span></span><span> </span><span id="local-6989586621679034023"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679034023"><span class="hs-identifier hs-var">fileName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ContT (IORef ReadHandle) m (IORef ReadHandle)
-&gt; m (IORef ReadHandle)
forall (m :: * -&gt; *) r. Monad m =&gt; ContT r m r -&gt; m r
</span><span class="hs-identifier hs-var">evalContT</span></span><span> </span><span class="annot"><span class="annottext">(ContT (IORef ReadHandle) m (IORef ReadHandle)
 -&gt; m (IORef ReadHandle))
-&gt; (((IORef ReadHandle -&gt; ContT (IORef ReadHandle) m ())
     -&gt; ContT (IORef ReadHandle) m (IORef ReadHandle))
    -&gt; ContT (IORef ReadHandle) m (IORef ReadHandle))
-&gt; ((IORef ReadHandle -&gt; ContT (IORef ReadHandle) m ())
    -&gt; ContT (IORef ReadHandle) m (IORef ReadHandle))
-&gt; m (IORef ReadHandle)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">((IORef ReadHandle -&gt; ContT (IORef ReadHandle) m ())
 -&gt; ContT (IORef ReadHandle) m (IORef ReadHandle))
-&gt; ContT (IORef ReadHandle) m (IORef ReadHandle)
forall k a (r :: k) (m :: k -&gt; *) b.
((a -&gt; ContT r m b) -&gt; ContT r m a) -&gt; ContT r m a
</span><span class="hs-identifier hs-var">callCC</span></span><span> </span><span class="annot"><span class="annottext">(((IORef ReadHandle -&gt; ContT (IORef ReadHandle) m ())
  -&gt; ContT (IORef ReadHandle) m (IORef ReadHandle))
 -&gt; m (IORef ReadHandle))
-&gt; ((IORef ReadHandle -&gt; ContT (IORef ReadHandle) m ())
    -&gt; ContT (IORef ReadHandle) m (IORef ReadHandle))
-&gt; m (IORef ReadHandle)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679034022"><span class="annot"><span class="annottext">IORef ReadHandle -&gt; ContT (IORef ReadHandle) m ()
</span><a href="#local-6989586621679034022"><span class="hs-identifier hs-var">ret</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-211"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Main.html#FileSystem"><span class="hs-identifier hs-type">FileSystem</span></a></span><span> </span><span id="local-6989586621679034021"><span class="annot"><span class="annottext">Set File
</span><a href="#local-6989586621679034021"><span class="hs-identifier hs-var">_files</span></a></span></span><span> </span><span id="local-6989586621679034020"><span class="annot"><span class="annottext">Set String
</span><a href="#local-6989586621679034020"><span class="hs-identifier hs-var">_fileNames</span></a></span></span><span> </span><span id="local-6989586621679034019"><span class="annot"><span class="annottext">ReverseLookup
</span><a href="#local-6989586621679034019"><span class="hs-identifier hs-var">_rl</span></a></span></span><span> </span><span id="local-6989586621679034018"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679034018"><span class="hs-identifier hs-var">_freeIndex</span></a></span></span><span> </span><span id="local-6989586621679034017"><span class="annot"><span class="annottext">Map String (IORef ReadHandle)
</span><a href="#local-6989586621679034017"><span class="hs-identifier hs-var">filesToRead</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ContT (IORef ReadHandle) m FileSystem
forall s (m :: * -&gt; *). MonadState s m =&gt; m s
</span><span class="hs-identifier hs-var">get</span></span><span>
</span><span id="line-212"></span><span>
</span><span id="line-213"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679034016"><span class="annot"><span class="annottext">oldHandle :: Maybe (IORef ReadHandle)
</span><a href="#local-6989586621679034016"><span class="hs-identifier hs-var hs-var">oldHandle</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Map String (IORef ReadHandle) -&gt; Maybe (IORef ReadHandle)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679034023"><span class="hs-identifier hs-var">fileName</span></a></span><span> </span><span class="annot"><span class="annottext">Map String (IORef ReadHandle)
</span><a href="#local-6989586621679034017"><span class="hs-identifier hs-var">filesToRead</span></a></span><span>
</span><span id="line-214"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (IORef ReadHandle)
</span><a href="#local-6989586621679034016"><span class="hs-identifier hs-var">oldHandle</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-215"></span><span>    </span><span class="annot"><span class="annottext">Maybe (IORef ReadHandle)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ContT (IORef ReadHandle) m ()
forall (f :: * -&gt; *). Applicative f =&gt; f ()
</span><a href="Main.html#continue"><span class="hs-identifier hs-var">continue</span></a></span><span>
</span><span id="line-216"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679034015"><span class="annot"><span class="annottext">IORef ReadHandle
</span><a href="#local-6989586621679034015"><span class="hs-identifier hs-var">h</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IORef ReadHandle -&gt; ContT (IORef ReadHandle) m ()
</span><a href="#local-6989586621679034022"><span class="hs-identifier hs-var">ret</span></a></span><span> </span><span class="annot"><span class="annottext">IORef ReadHandle
</span><a href="#local-6989586621679034015"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="hs-comment">-- break early if handle already exists</span><span>
</span><span id="line-217"></span><span>
</span><span id="line-218"></span><span>  </span><span id="local-6989586621679034014"><span class="annot"><span class="annottext">IORef ReadHandle
</span><a href="#local-6989586621679034014"><span class="hs-identifier hs-var">newHandle</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (IORef ReadHandle)
-&gt; ContT (IORef ReadHandle) m (IORef ReadHandle)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (IORef ReadHandle)
 -&gt; ContT (IORef ReadHandle) m (IORef ReadHandle))
-&gt; (ReadHandle -&gt; IO (IORef ReadHandle))
-&gt; ReadHandle
-&gt; ContT (IORef ReadHandle) m (IORef ReadHandle)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ReadHandle -&gt; IO (IORef ReadHandle)
forall a. a -&gt; IO (IORef a)
</span><span class="hs-identifier hs-var">newIORef</span></span><span> </span><span class="annot"><span class="annottext">(ReadHandle -&gt; ContT (IORef ReadHandle) m (IORef ReadHandle))
-&gt; ReadHandle -&gt; ContT (IORef ReadHandle) m (IORef ReadHandle)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ContiguousData -&gt; Bool -&gt; ReadHandle
</span><a href="Main.html#ReadHandle"><span class="hs-identifier hs-var">ReadHandle</span></a></span><span> </span><span class="annot"><span class="annottext">ContiguousData
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-219"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679034013"><span class="annot"><span class="annottext">newFilesToRead :: Map String (IORef ReadHandle)
</span><a href="#local-6989586621679034013"><span class="hs-identifier hs-var hs-var">newFilesToRead</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
-&gt; IORef ReadHandle
-&gt; Map String (IORef ReadHandle)
-&gt; Map String (IORef ReadHandle)
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.insert</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679034023"><span class="hs-identifier hs-var">fileName</span></a></span><span> </span><span class="annot"><span class="annottext">IORef ReadHandle
</span><a href="#local-6989586621679034014"><span class="hs-identifier hs-var">newHandle</span></a></span><span> </span><span class="annot"><span class="annottext">Map String (IORef ReadHandle)
</span><a href="#local-6989586621679034017"><span class="hs-identifier hs-var">filesToRead</span></a></span><span>
</span><span id="line-220"></span><span>  </span><span class="annot"><span class="annottext">(FileSystem -&gt; FileSystem) -&gt; ContT (IORef ReadHandle) m ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify'</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679034012"><span class="annot"><span class="annottext">FileSystem
</span><a href="#local-6989586621679034012"><span class="hs-identifier hs-var">fs'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FileSystem
</span><a href="#local-6989586621679034012"><span class="hs-identifier hs-var">fs'</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">filesToRead :: Map String (IORef ReadHandle)
</span><a href="Main.html#filesToRead"><span class="hs-identifier hs-var">filesToRead</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map String (IORef ReadHandle)
</span><a href="#local-6989586621679034013"><span class="hs-identifier hs-var">newFilesToRead</span></a></span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-221"></span><span>
</span><span id="line-222"></span><span>  </span><span class="hs-identifier">return</span><span> </span><span class="annot"><span class="annottext">IORef ReadHandle
</span><a href="#local-6989586621679034014"><span class="hs-identifier hs-var">newHandle</span></a></span><span>
</span><span id="line-223"></span><span>
</span><span id="line-224"></span><span class="hs-comment">-- Bonus part: implement a concrete disk implementation to test w/</span><span>
</span><span id="line-225"></span><span>
</span><span id="line-226"></span><span class="hs-comment">-- | We create a DSL to write sequences of disk instructions in</span><span>
</span><span id="line-227"></span><span class="hs-keyword">data</span><span> </span><span id="Simulator"><span class="annot"><a href="Main.html#Simulator"><span class="hs-identifier hs-var">Simulator</span></a></span></span><span> </span><span id="local-6989586621679034011"><span class="annot"><a href="#local-6989586621679034011"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-228"></span><span>  </span><span id="local-6989586621679034009"><span id="local-6989586621679034010"><span id="Bind"><span class="annot"><a href="Main.html#Bind"><span class="hs-identifier hs-var">Bind</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Main.html#Simulator"><span class="hs-identifier hs-type">Simulator</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679034010"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679034010"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Main.html#Simulator"><span class="hs-identifier hs-type">Simulator</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679034009"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Main.html#Simulator"><span class="hs-identifier hs-type">Simulator</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679034009"><span class="hs-identifier hs-type">b</span></a></span></span></span><span>
</span><span id="line-229"></span><span>  </span><span id="local-6989586621679034007"><span id="Pure"><span class="annot"><a href="Main.html#Pure"><span class="hs-identifier hs-var">Pure</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679034007"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Main.html#Simulator"><span class="hs-identifier hs-type">Simulator</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679034007"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-230"></span><span>  </span><span id="TryCreateFile"><span class="annot"><a href="Main.html#TryCreateFile"><span class="hs-identifier hs-var">TryCreateFile</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Main.html#Simulator"><span class="hs-identifier hs-type">Simulator</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-231"></span><span>  </span><span id="SpinTo"><span class="annot"><a href="Main.html#SpinTo"><span class="hs-identifier hs-var">SpinTo</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Main.html#Simulator"><span class="hs-identifier hs-type">Simulator</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-232"></span><span>  </span><span id="TryRead"><span class="annot"><a href="Main.html#TryRead"><span class="hs-identifier hs-var">TryRead</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Main.html#Simulator"><span class="hs-identifier hs-type">Simulator</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-233"></span><span>  </span><span id="PrintState"><span class="annot"><a href="Main.html#PrintState"><span class="hs-identifier hs-var">PrintState</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Main.html#Simulator"><span class="hs-identifier hs-type">Simulator</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-234"></span><span>
</span><span id="line-235"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679033996"><span id="local-6989586621679033998"><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="Main.html#Simulator"><span class="hs-identifier hs-type">Simulator</span></a></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-236"></span><span>  </span><span id="local-6989586621679033994"><span class="annot"><span class="annottext">&gt;&gt;= :: Simulator a -&gt; (a -&gt; Simulator b) -&gt; Simulator b
</span><span class="hs-operator hs-var hs-var hs-var hs-var">(&gt;&gt;=)</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Simulator a -&gt; (a -&gt; Simulator b) -&gt; Simulator b
forall a b. Simulator a -&gt; (a -&gt; Simulator b) -&gt; Simulator b
</span><a href="Main.html#Bind"><span class="hs-identifier hs-var">Bind</span></a></span><span>
</span><span id="line-237"></span><span>
</span><span id="line-238"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679033985"><span id="local-6989586621679033987"><span id="local-6989586621679033989"><span class="annot"><span class="hs-identifier hs-type">Applicative</span></span><span> </span><span class="annot"><a href="Main.html#Simulator"><span class="hs-identifier hs-type">Simulator</span></a></span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-239"></span><span>  </span><span id="local-6989586621679033983"><span class="annot"><span class="annottext">pure :: a -&gt; Simulator a
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">pure</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; Simulator a
forall a. a -&gt; Simulator a
</span><a href="Main.html#Pure"><span class="hs-identifier hs-var">Pure</span></a></span><span>
</span><span id="line-240"></span><span>  </span><span id="local-6989586621679033982"><span class="annot"><span class="annottext">&lt;*&gt; :: Simulator (a -&gt; b) -&gt; Simulator a -&gt; Simulator b
</span><span class="hs-operator hs-var hs-var hs-var hs-var">(&lt;*&gt;)</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Simulator (a -&gt; b) -&gt; Simulator a -&gt; Simulator b
forall (m :: * -&gt; *) a b. Monad m =&gt; m (a -&gt; b) -&gt; m a -&gt; m b
</span><span class="hs-identifier hs-var">ap</span></span><span>
</span><span id="line-241"></span><span>
</span><span id="line-242"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679033979"><span class="annot"><span class="hs-identifier hs-type">Functor</span></span><span> </span><span class="annot"><a href="Main.html#Simulator"><span class="hs-identifier hs-type">Simulator</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-243"></span><span>  </span><span id="local-6989586621679033977"><span class="annot"><span class="annottext">fmap :: (a -&gt; b) -&gt; Simulator a -&gt; Simulator b
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">fmap</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(a -&gt; b) -&gt; Simulator a -&gt; Simulator b
forall (m :: * -&gt; *) a1 r. Monad m =&gt; (a1 -&gt; r) -&gt; m a1 -&gt; m r
</span><span class="hs-identifier hs-var">liftM</span></span><span>
</span><span id="line-244"></span><span>
</span><span id="line-245"></span><span class="hs-comment">-- | Sample program using the dsl to create 3 files and try reading them at various times</span><span>
</span><span id="line-246"></span><span class="annot"><a href="Main.html#sampleProgram"><span class="hs-identifier hs-type">sampleProgram</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Main.html#Simulator"><span class="hs-identifier hs-type">Simulator</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-247"></span><span id="sampleProgram"><span class="annot"><span class="annottext">sampleProgram :: Simulator ()
</span><a href="Main.html#sampleProgram"><span class="hs-identifier hs-var hs-var">sampleProgram</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-248"></span><span>  </span><span class="annot"><span class="annottext">Simulator ()
</span><a href="Main.html#PrintState"><span class="hs-identifier hs-var">PrintState</span></a></span><span>
</span><span id="line-249"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; String -&gt; Simulator ()
</span><a href="Main.html#TryCreateFile"><span class="hs-identifier hs-var">TryCreateFile</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;file1&quot;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;asdfghjkl&quot;</span></span><span>
</span><span id="line-250"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; String -&gt; Simulator ()
</span><a href="Main.html#TryCreateFile"><span class="hs-identifier hs-var">TryCreateFile</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;file2&quot;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;asdfghjkl&quot;</span></span><span>
</span><span id="line-251"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; Simulator ()
</span><a href="Main.html#TryRead"><span class="hs-identifier hs-var">TryRead</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;file1&quot;</span></span><span>
</span><span id="line-252"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; Simulator ()
</span><a href="Main.html#TryRead"><span class="hs-identifier hs-var">TryRead</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;file2&quot;</span></span><span>
</span><span id="line-253"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; Simulator ()
</span><a href="Main.html#TryRead"><span class="hs-identifier hs-var">TryRead</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;file3&quot;</span></span><span>
</span><span id="line-254"></span><span>  </span><span class="annot"><span class="annottext">(Int -&gt; Simulator ()) -&gt; [Int] -&gt; Simulator ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><span class="hs-identifier hs-var">traverse_</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Simulator ()
</span><a href="Main.html#SpinTo"><span class="hs-identifier hs-var">SpinTo</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">12</span></span><span class="hs-special">]</span><span>
</span><span id="line-255"></span><span>  </span><span class="annot"><span class="annottext">(Int -&gt; Simulator ()) -&gt; [Int] -&gt; Simulator ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><span class="hs-identifier hs-var">traverse_</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Simulator ()
</span><a href="Main.html#SpinTo"><span class="hs-identifier hs-var">SpinTo</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">12</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">11</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">]</span><span>
</span><span id="line-256"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; Simulator ()
</span><a href="Main.html#TryRead"><span class="hs-identifier hs-var">TryRead</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;file1&quot;</span></span><span>
</span><span id="line-257"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; Simulator ()
</span><a href="Main.html#TryRead"><span class="hs-identifier hs-var">TryRead</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;file2&quot;</span></span><span>
</span><span id="line-258"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; Simulator ()
</span><a href="Main.html#TryRead"><span class="hs-identifier hs-var">TryRead</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;file3&quot;</span></span><span>
</span><span id="line-259"></span><span>  </span><span class="annot"><span class="annottext">(Int -&gt; Simulator ()) -&gt; [Int] -&gt; Simulator ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><span class="hs-identifier hs-var">traverse_</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Simulator ()
</span><a href="Main.html#SpinTo"><span class="hs-identifier hs-var">SpinTo</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">15</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">17</span></span><span class="hs-special">]</span><span>
</span><span id="line-260"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; Simulator ()
</span><a href="Main.html#TryRead"><span class="hs-identifier hs-var">TryRead</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;file1&quot;</span></span><span>
</span><span id="line-261"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; Simulator ()
</span><a href="Main.html#TryRead"><span class="hs-identifier hs-var">TryRead</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;file2&quot;</span></span><span>
</span><span id="line-262"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; Simulator ()
</span><a href="Main.html#TryRead"><span class="hs-identifier hs-var">TryRead</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;file3&quot;</span></span><span>
</span><span id="line-263"></span><span>  </span><span class="annot"><span class="annottext">(Int -&gt; Simulator ()) -&gt; [Int] -&gt; Simulator ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><span class="hs-identifier hs-var">traverse_</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Simulator ()
</span><a href="Main.html#SpinTo"><span class="hs-identifier hs-var">SpinTo</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">12</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">20</span></span><span class="hs-special">]</span><span>
</span><span id="line-264"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; Simulator ()
</span><a href="Main.html#TryRead"><span class="hs-identifier hs-var">TryRead</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;file1&quot;</span></span><span>
</span><span id="line-265"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; Simulator ()
</span><a href="Main.html#TryRead"><span class="hs-identifier hs-var">TryRead</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;file2&quot;</span></span><span>
</span><span id="line-266"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; Simulator ()
</span><a href="Main.html#TryRead"><span class="hs-identifier hs-var">TryRead</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;file3&quot;</span></span><span>
</span><span id="line-267"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; String -&gt; Simulator ()
</span><a href="Main.html#TryCreateFile"><span class="hs-identifier hs-var">TryCreateFile</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;file3&quot;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;nn&quot;</span></span><span>
</span><span id="line-268"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; Simulator ()
</span><a href="Main.html#TryRead"><span class="hs-identifier hs-var">TryRead</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;file3&quot;</span></span><span>
</span><span id="line-269"></span><span>  </span><span class="annot"><span class="annottext">(Int -&gt; Simulator ()) -&gt; [Int] -&gt; Simulator ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><span class="hs-identifier hs-var">traverse_</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Simulator ()
</span><a href="Main.html#SpinTo"><span class="hs-identifier hs-var">SpinTo</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">100</span></span><span class="hs-special">]</span><span>
</span><span id="line-270"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; Simulator ()
</span><a href="Main.html#TryRead"><span class="hs-identifier hs-var">TryRead</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;file3&quot;</span></span><span>
</span><span id="line-271"></span><span>  </span><span class="annot"><span class="annottext">Simulator ()
</span><a href="Main.html#PrintState"><span class="hs-identifier hs-var">PrintState</span></a></span><span>
</span><span id="line-272"></span><span>
</span><span id="line-273"></span><span class="hs-comment">-- | Concrete implementation of Disk</span><span>
</span><span id="line-274"></span><span class="hs-keyword">data</span><span> </span><span id="ConcreteDisk"><span class="annot"><a href="Main.html#ConcreteDisk"><span class="hs-identifier hs-var">ConcreteDisk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ConcreteDisk"><span class="annot"><a href="Main.html#ConcreteDisk"><span class="hs-identifier hs-var">ConcreteDisk</span></a></span></span><span>
</span><span id="line-275"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="cLength"><span class="annot"><span class="annottext">ConcreteDisk -&gt; Int
</span><a href="Main.html#cLength"><span class="hs-identifier hs-var hs-var">cLength</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span>
</span><span id="line-276"></span><span>    </span><span id="cCurPos"><span class="annot"><span class="annottext">ConcreteDisk -&gt; IORef Int
</span><a href="Main.html#cCurPos"><span class="hs-identifier hs-var hs-var">cCurPos</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IORef</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span>
</span><span id="line-277"></span><span>    </span><span id="cStuff"><span class="annot"><span class="annottext">ConcreteDisk -&gt; IORef ContiguousData
</span><a href="Main.html#cStuff"><span class="hs-identifier hs-var hs-var">cStuff</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IORef</span></span><span> </span><span class="annot"><a href="Main.html#ContiguousData"><span class="hs-identifier hs-type">ContiguousData</span></a></span><span>
</span><span id="line-278"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-279"></span><span>
</span><span id="line-280"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Main.html#Disk"><span class="hs-identifier hs-type">Disk</span></a></span><span> </span><span class="annot"><a href="Main.html#ConcreteDisk"><span class="hs-identifier hs-type">ConcreteDisk</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-281"></span><span>  </span><span id="local-6989586621679033966"><span class="annot"><span class="annottext">dlength :: ConcreteDisk -&gt; Int
</span><a href="#local-6989586621679033966"><span class="hs-identifier hs-var hs-var hs-var hs-var">dlength</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConcreteDisk -&gt; Int
</span><a href="Main.html#cLength"><span class="hs-identifier hs-var hs-var">cLength</span></a></span><span>
</span><span id="line-282"></span><span>  </span><span id="local-6989586621679033965"><span class="annot"><span class="annottext">current_position :: ConcreteDisk -&gt; IO Int
</span><a href="#local-6989586621679033965"><span class="hs-identifier hs-var hs-var hs-var hs-var">current_position</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IORef Int -&gt; IO Int
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">(IORef Int -&gt; IO Int)
-&gt; (ConcreteDisk -&gt; IORef Int) -&gt; ConcreteDisk -&gt; IO Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ConcreteDisk -&gt; IORef Int
</span><a href="Main.html#cCurPos"><span class="hs-identifier hs-var hs-var">cCurPos</span></a></span><span>
</span><span id="line-283"></span><span>  </span><span id="local-6989586621679033964"><span class="annot"><span class="annottext">read :: ConcreteDisk -&gt; IO Char
</span><a href="#local-6989586621679033964"><span class="hs-identifier hs-var hs-var hs-var hs-var">read</span></a></span></span><span> </span><span id="local-6989586621679033963"><span class="annot"><span class="annottext">ConcreteDisk
</span><a href="#local-6989586621679033963"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-284"></span><span>    </span><span id="local-6989586621679033962"><span class="annot"><span class="annottext">ContiguousData
</span><a href="#local-6989586621679033962"><span class="hs-identifier hs-var">stuff</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef ContiguousData -&gt; IO ContiguousData
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">(IORef ContiguousData -&gt; IO ContiguousData)
-&gt; IORef ContiguousData -&gt; IO ContiguousData
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConcreteDisk -&gt; IORef ContiguousData
</span><a href="Main.html#cStuff"><span class="hs-identifier hs-var hs-var">cStuff</span></a></span><span> </span><span class="annot"><span class="annottext">ConcreteDisk
</span><a href="#local-6989586621679033963"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-285"></span><span>    </span><span id="local-6989586621679033961"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679033961"><span class="hs-identifier hs-var">curPos</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef Int -&gt; IO Int
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">(IORef Int -&gt; IO Int) -&gt; IORef Int -&gt; IO Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConcreteDisk -&gt; IORef Int
</span><a href="Main.html#cCurPos"><span class="hs-identifier hs-var hs-var">cCurPos</span></a></span><span> </span><span class="annot"><span class="annottext">ConcreteDisk
</span><a href="#local-6989586621679033963"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-286"></span><span>    </span><span class="annot"><span class="annottext">Char -&gt; IO Char
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Char -&gt; IO Char)
-&gt; (Map Int Char -&gt; Char) -&gt; Map Int Char -&gt; IO Char
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Char -&gt; Maybe Char -&gt; Char
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'_'</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Char -&gt; Char)
-&gt; (Map Int Char -&gt; Maybe Char) -&gt; Map Int Char -&gt; Char
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Map Int Char -&gt; Maybe Char
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679033961"><span class="hs-identifier hs-var">curPos</span></a></span><span> </span><span class="annot"><span class="annottext">(Map Int Char -&gt; IO Char) -&gt; Map Int Char -&gt; IO Char
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ContiguousData -&gt; Map Int Char
</span><a href="Main.html#cData"><span class="hs-identifier hs-var hs-var">cData</span></a></span><span> </span><span class="annot"><span class="annottext">ContiguousData
</span><a href="#local-6989586621679033962"><span class="hs-identifier hs-var">stuff</span></a></span><span>
</span><span id="line-287"></span><span>  </span><span id="local-6989586621679033960"><span class="annot"><span class="annottext">write :: ConcreteDisk -&gt; Char -&gt; IO ()
</span><a href="#local-6989586621679033960"><span class="hs-identifier hs-var hs-var hs-var hs-var">write</span></a></span></span><span> </span><span id="local-6989586621679033959"><span class="annot"><span class="annottext">ConcreteDisk
</span><a href="#local-6989586621679033959"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span id="local-6989586621679033958"><span class="annot"><span class="annottext">Char
</span><a href="#local-6989586621679033958"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-288"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679033957"><span class="annot"><span class="annottext">stuffRef :: IORef ContiguousData
</span><a href="#local-6989586621679033957"><span class="hs-identifier hs-var hs-var">stuffRef</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConcreteDisk -&gt; IORef ContiguousData
</span><a href="Main.html#cStuff"><span class="hs-identifier hs-var hs-var">cStuff</span></a></span><span> </span><span class="annot"><span class="annottext">ConcreteDisk
</span><a href="#local-6989586621679033959"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-289"></span><span>    </span><span id="local-6989586621679033956"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679033956"><span class="hs-identifier hs-var">curPos</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef Int -&gt; IO Int
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">(IORef Int -&gt; IO Int) -&gt; IORef Int -&gt; IO Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConcreteDisk -&gt; IORef Int
</span><a href="Main.html#cCurPos"><span class="hs-identifier hs-var hs-var">cCurPos</span></a></span><span> </span><span class="annot"><span class="annottext">ConcreteDisk
</span><a href="#local-6989586621679033959"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-290"></span><span>    </span><span class="annot"><span class="annottext">IORef ContiguousData -&gt; (ContiguousData -&gt; ContiguousData) -&gt; IO ()
forall a. IORef a -&gt; (a -&gt; a) -&gt; IO ()
</span><span class="hs-identifier hs-var">modifyIORef'</span></span><span> </span><span class="annot"><span class="annottext">IORef ContiguousData
</span><a href="#local-6989586621679033957"><span class="hs-identifier hs-var">stuffRef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Map Int Char -&gt; Map Int Char) -&gt; ContiguousData -&gt; ContiguousData
</span><a href="Main.html#cMap"><span class="hs-identifier hs-var">cMap</span></a></span><span> </span><span class="annot"><span class="annottext">((Map Int Char -&gt; Map Int Char)
 -&gt; ContiguousData -&gt; ContiguousData)
-&gt; (Map Int Char -&gt; Map Int Char)
-&gt; ContiguousData
-&gt; ContiguousData
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Char -&gt; Map Int Char -&gt; Map Int Char
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.insert</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679033956"><span class="hs-identifier hs-var">curPos</span></a></span><span> </span><span class="annot"><span class="annottext">Char
</span><a href="#local-6989586621679033958"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-291"></span><span>
</span><span id="line-292"></span><span class="hs-comment">-- | Haskell can auto derive printing most data types, but not if the type is impure.</span><span>
</span><span id="line-293"></span><span class="annot"><a href="Main.html#printFs"><span class="hs-identifier hs-type">printFs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Main.html#FileSystem"><span class="hs-identifier hs-type">FileSystem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-294"></span><span id="printFs"><span class="annot"><span class="annottext">printFs :: FileSystem -&gt; IO ()
</span><a href="Main.html#printFs"><span class="hs-identifier hs-var hs-var">printFs</span></a></span></span><span> </span><span id="local-6989586621679033954"><span class="annot"><span class="annottext">FileSystem
</span><a href="#local-6989586621679033954"><span class="hs-identifier hs-var">fs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-295"></span><span>  </span><span id="local-6989586621679033953"><span class="annot"><span class="annottext">Map String ReadHandle
</span><a href="#local-6989586621679033953"><span class="hs-identifier hs-var">ftr</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="annot"><a href="Main.html#ReadHandle"><span class="hs-identifier hs-type">ReadHandle</span></a></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(IORef ReadHandle -&gt; IO ReadHandle)
-&gt; Map String (IORef ReadHandle) -&gt; IO (Map String ReadHandle)
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="annot"><span class="annottext">IORef ReadHandle -&gt; IO ReadHandle
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FileSystem -&gt; Map String (IORef ReadHandle)
</span><a href="Main.html#filesToRead"><span class="hs-identifier hs-var hs-var">filesToRead</span></a></span><span> </span><span class="annot"><span class="annottext">FileSystem
</span><a href="#local-6989586621679033954"><span class="hs-identifier hs-var">fs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-296"></span><span>  </span><span class="annot"><span class="annottext">Map String ReadHandle -&gt; IO ()
forall a. Show a =&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">print</span></span><span> </span><span class="annot"><span class="annottext">Map String ReadHandle
</span><a href="#local-6989586621679033953"><span class="hs-identifier hs-var">ftr</span></a></span><span>
</span><span id="line-297"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; IO ()
</span><span class="hs-identifier hs-var">putStrLn</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; IO ()) -&gt; String -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-298"></span><span>    </span><span class="annot"><span class="annottext">[String] -&gt; String
</span><span class="hs-identifier hs-var">unwords</span></span><span>
</span><span id="line-299"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;FileSystem&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-300"></span><span>        </span><span class="annot"><span class="annottext">Set File -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">(Set File -&gt; String) -&gt; Set File -&gt; String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FileSystem -&gt; Set File
</span><a href="Main.html#files"><span class="hs-identifier hs-var hs-var">files</span></a></span><span> </span><span class="annot"><span class="annottext">FileSystem
</span><a href="#local-6989586621679033954"><span class="hs-identifier hs-var">fs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-301"></span><span>        </span><span class="annot"><span class="annottext">Set String -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">(Set String -&gt; String) -&gt; Set String -&gt; String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FileSystem -&gt; Set String
</span><a href="Main.html#fileNames"><span class="hs-identifier hs-var hs-var">fileNames</span></a></span><span> </span><span class="annot"><span class="annottext">FileSystem
</span><a href="#local-6989586621679033954"><span class="hs-identifier hs-var">fs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-302"></span><span>        </span><span class="annot"><span class="annottext">ReverseLookup -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">(ReverseLookup -&gt; String) -&gt; ReverseLookup -&gt; String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FileSystem -&gt; ReverseLookup
</span><a href="Main.html#freverseLookup"><span class="hs-identifier hs-var hs-var">freverseLookup</span></a></span><span> </span><span class="annot"><span class="annottext">FileSystem
</span><a href="#local-6989586621679033954"><span class="hs-identifier hs-var">fs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-303"></span><span>        </span><span class="annot"><span class="annottext">Int -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; String) -&gt; Int -&gt; String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FileSystem -&gt; Int
</span><a href="Main.html#freeIndex"><span class="hs-identifier hs-var hs-var">freeIndex</span></a></span><span> </span><span class="annot"><span class="annottext">FileSystem
</span><a href="#local-6989586621679033954"><span class="hs-identifier hs-var">fs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-304"></span><span>        </span><span class="annot"><span class="annottext">Map String ReadHandle -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Map String ReadHandle
</span><a href="#local-6989586621679033953"><span class="hs-identifier hs-var">ftr</span></a></span><span>
</span><span id="line-305"></span><span>      </span><span class="hs-special">]</span><span>
</span><span id="line-306"></span><span>
</span><span id="line-307"></span><span class="hs-comment">-- | @Disk@ is also impure so it also needs its own print</span><span>
</span><span id="line-308"></span><span id="printDisk"><span class="annot"><span class="annottext">printDisk :: ConcreteDisk -&gt; IO ()
</span><a href="Main.html#printDisk"><span class="hs-identifier hs-var hs-var">printDisk</span></a></span></span><span> </span><span id="local-6989586621679033949"><span class="annot"><span class="annottext">ConcreteDisk
</span><a href="#local-6989586621679033949"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-309"></span><span>  </span><span id="local-6989586621679033948"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679033948"><span class="hs-identifier hs-var">curPos</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef Int -&gt; IO Int
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">(IORef Int -&gt; IO Int) -&gt; IORef Int -&gt; IO Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConcreteDisk -&gt; IORef Int
</span><a href="Main.html#cCurPos"><span class="hs-identifier hs-var hs-var">cCurPos</span></a></span><span> </span><span class="annot"><span class="annottext">ConcreteDisk
</span><a href="#local-6989586621679033949"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-310"></span><span>  </span><span id="local-6989586621679033947"><span class="annot"><span class="annottext">ContiguousData
</span><a href="#local-6989586621679033947"><span class="hs-identifier hs-var">stuff</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef ContiguousData -&gt; IO ContiguousData
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">(IORef ContiguousData -&gt; IO ContiguousData)
-&gt; IORef ContiguousData -&gt; IO ContiguousData
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConcreteDisk -&gt; IORef ContiguousData
</span><a href="Main.html#cStuff"><span class="hs-identifier hs-var hs-var">cStuff</span></a></span><span> </span><span class="annot"><span class="annottext">ConcreteDisk
</span><a href="#local-6989586621679033949"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-311"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; IO ()
</span><span class="hs-identifier hs-var">putStrLn</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; IO ()) -&gt; String -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[String] -&gt; String
</span><span class="hs-identifier hs-var">unwords</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Disk&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConcreteDisk -&gt; Int
</span><a href="Main.html#cLength"><span class="hs-identifier hs-var hs-var">cLength</span></a></span><span> </span><span class="annot"><span class="annottext">ConcreteDisk
</span><a href="#local-6989586621679033949"><span class="hs-identifier hs-var">d</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679033948"><span class="hs-identifier hs-var">curPos</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ContiguousData -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">ContiguousData
</span><a href="#local-6989586621679033947"><span class="hs-identifier hs-var">stuff</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-312"></span><span>
</span><span id="line-313"></span><span class="hs-comment">-- | @runSimulation@ has access to a ConcreteDisk environment, a FileSystem internal state, and IO</span><span>
</span><span id="line-314"></span><span id="local-6989586621679034210"><span id="local-6989586621679034211"><span class="annot"><a href="Main.html#runSimulation"><span class="hs-identifier hs-type">runSimulation</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-315"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679034211"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="annot"><a href="Main.html#ConcreteDisk"><span class="hs-identifier hs-type">ConcreteDisk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679034211"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadState</span></span><span> </span><span class="annot"><a href="Main.html#FileSystem"><span class="hs-identifier hs-type">FileSystem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679034211"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679034211"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-316"></span><span>  </span><span class="annot"><a href="Main.html#Simulator"><span class="hs-identifier hs-type">Simulator</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679034210"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-317"></span><span>  </span><span class="annot"><a href="#local-6989586621679034211"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679034210"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-318"></span><span id="runSimulation"><span class="annot"><span class="annottext">runSimulation :: Simulator a -&gt; m a
</span><a href="Main.html#runSimulation"><span class="hs-identifier hs-var hs-var">runSimulation</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Main.html#TryCreateFile"><span class="hs-identifier hs-type">TryCreateFile</span></a></span><span> </span><span id="local-6989586621679033945"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679033945"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621679033944"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679033944"><span class="hs-identifier hs-var">contents</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-319"></span><span>  </span><span id="local-6989586621679033943"><span class="annot"><span class="annottext">ConcreteDisk
</span><a href="#local-6989586621679033943"><span class="hs-identifier hs-var">disk</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m ConcreteDisk
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-320"></span><span>  </span><span id="local-6989586621679033942"><span class="annot"><span class="annottext">FileSystem
</span><a href="#local-6989586621679033942"><span class="hs-identifier hs-var">fs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m FileSystem
forall s (m :: * -&gt; *). MonadState s m =&gt; m s
</span><span class="hs-identifier hs-var">get</span></span><span>
</span><span id="line-321"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679033941"><span class="annot"><span class="annottext">newFs :: Maybe FileSystem
</span><a href="#local-6989586621679033941"><span class="hs-identifier hs-var hs-var">newFs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ReaderT ConcreteDisk Maybe FileSystem
-&gt; ConcreteDisk -&gt; Maybe FileSystem
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var hs-var">runReaderT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FileSystem
-&gt; String -&gt; String -&gt; ReaderT ConcreteDisk Maybe FileSystem
forall (m :: * -&gt; *) a.
(Monad m, Disk a, MonadReader a m, MonadPlus m) =&gt;
FileSystem -&gt; String -&gt; String -&gt; m FileSystem
</span><a href="Main.html#createFile"><span class="hs-identifier hs-var">createFile</span></a></span><span> </span><span class="annot"><span class="annottext">FileSystem
</span><a href="#local-6989586621679033942"><span class="hs-identifier hs-var">fs</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679033945"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679033944"><span class="hs-identifier hs-var">contents</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ConcreteDisk
</span><a href="#local-6989586621679033943"><span class="hs-identifier hs-var">disk</span></a></span><span>
</span><span id="line-322"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe FileSystem
</span><a href="#local-6989586621679033941"><span class="hs-identifier hs-var">newFs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-323"></span><span>    </span><span class="annot"><span class="annottext">Maybe FileSystem
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; (String -&gt; IO ()) -&gt; String -&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; IO ()
</span><span class="hs-identifier hs-var">putStrLn</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; m ()) -&gt; String -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[String] -&gt; String
</span><span class="hs-identifier hs-var">unwords</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Failed to create file&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679033945"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;with contents&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ShowS
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679033944"><span class="hs-identifier hs-var">contents</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-324"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679033940"><span class="annot"><span class="annottext">FileSystem
</span><a href="#local-6989586621679033940"><span class="hs-identifier hs-var">newFs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-325"></span><span>      </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; (String -&gt; IO ()) -&gt; String -&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; IO ()
</span><span class="hs-identifier hs-var">putStrLn</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; m ()) -&gt; String -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[String] -&gt; String
</span><span class="hs-identifier hs-var">unwords</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Created file&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679033945"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;with contents&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ShowS
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679033944"><span class="hs-identifier hs-var">contents</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-326"></span><span>      </span><span class="annot"><span class="annottext">FileSystem -&gt; m ()
forall s (m :: * -&gt; *). MonadState s m =&gt; s -&gt; m ()
</span><span class="hs-identifier hs-var">put</span></span><span> </span><span class="annot"><span class="annottext">FileSystem
</span><a href="#local-6989586621679033940"><span class="hs-identifier hs-var">newFs'</span></a></span><span>
</span><span id="line-327"></span><span class="annot"><a href="Main.html#runSimulation"><span class="hs-identifier hs-var">runSimulation</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Main.html#SpinTo"><span class="hs-identifier hs-type">SpinTo</span></a></span><span> </span><span id="local-6989586621679033939"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679033939"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-328"></span><span>  </span><span id="local-6989586621679033938"><span class="annot"><span class="annottext">ConcreteDisk
</span><a href="#local-6989586621679033938"><span class="hs-identifier hs-var">disk</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m ConcreteDisk
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-329"></span><span>  </span><span id="local-6989586621679033937"><span class="annot"><span class="annottext">FileSystem
</span><a href="#local-6989586621679033937"><span class="hs-identifier hs-var">fs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m FileSystem
forall s (m :: * -&gt; *). MonadState s m =&gt; m s
</span><span class="hs-identifier hs-var">get</span></span><span>
</span><span id="line-330"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679033936"><span class="annot"><span class="annottext">posRef :: IORef Int
</span><a href="#local-6989586621679033936"><span class="hs-identifier hs-var hs-var">posRef</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConcreteDisk -&gt; IORef Int
</span><a href="Main.html#cCurPos"><span class="hs-identifier hs-var hs-var">cCurPos</span></a></span><span> </span><span class="annot"><span class="annottext">ConcreteDisk
</span><a href="#local-6989586621679033938"><span class="hs-identifier hs-var">disk</span></a></span><span>
</span><span id="line-331"></span><span>  </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IORef Int -&gt; Int -&gt; IO ()
forall a. IORef a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">writeIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef Int
</span><a href="#local-6989586621679033936"><span class="hs-identifier hs-var">posRef</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679033939"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-332"></span><span>  </span><span id="local-6989586621679033935"><span class="annot"><span class="annottext">FileSystem
</span><a href="#local-6989586621679033935"><span class="hs-identifier hs-var">newFs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO FileSystem -&gt; m FileSystem
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO FileSystem -&gt; m FileSystem) -&gt; IO FileSystem -&gt; m FileSystem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ReaderT ConcreteDisk IO FileSystem -&gt; ConcreteDisk -&gt; IO FileSystem
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var hs-var">runReaderT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FileSystem -&gt; ReaderT ConcreteDisk IO FileSystem
forall (m :: * -&gt; *) a.
(Monad m, Disk a, MonadReader a m, MonadIO m) =&gt;
FileSystem -&gt; m FileSystem
</span><a href="Main.html#onDiskSpin"><span class="hs-identifier hs-var">onDiskSpin</span></a></span><span> </span><span class="annot"><span class="annottext">FileSystem
</span><a href="#local-6989586621679033937"><span class="hs-identifier hs-var">fs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ConcreteDisk
</span><a href="#local-6989586621679033938"><span class="hs-identifier hs-var">disk</span></a></span><span>
</span><span id="line-333"></span><span>  </span><span class="annot"><span class="annottext">FileSystem -&gt; m ()
forall s (m :: * -&gt; *). MonadState s m =&gt; s -&gt; m ()
</span><span class="hs-identifier hs-var">put</span></span><span> </span><span class="annot"><span class="annottext">FileSystem
</span><a href="#local-6989586621679033935"><span class="hs-identifier hs-var">newFs</span></a></span><span>
</span><span id="line-334"></span><span class="hs-comment">-- liftIO . putStrLn $ unwords [&quot;Spun to&quot;, show i]</span><span>
</span><span id="line-335"></span><span class="annot"><a href="Main.html#runSimulation"><span class="hs-identifier hs-var">runSimulation</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Main.html#TryRead"><span class="hs-identifier hs-type">TryRead</span></a></span><span> </span><span id="local-6989586621679033934"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679033934"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-336"></span><span>  </span><span id="local-6989586621679033933"><span class="annot"><span class="annottext">FileSystem
</span><a href="#local-6989586621679033933"><span class="hs-identifier hs-var">fs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m FileSystem
forall s (m :: * -&gt; *). MonadState s m =&gt; m s
</span><span class="hs-identifier hs-var">get</span></span><span>
</span><span id="line-337"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679033932"><span class="annot"><span class="annottext">IORef ReadHandle
</span><a href="#local-6989586621679033932"><span class="hs-identifier hs-var">handleRef</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679033931"><span class="annot"><span class="annottext">FileSystem
</span><a href="#local-6989586621679033931"><span class="hs-identifier hs-var">newFs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (IORef ReadHandle, FileSystem)
-&gt; m (IORef ReadHandle, FileSystem)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (IORef ReadHandle, FileSystem)
 -&gt; m (IORef ReadHandle, FileSystem))
-&gt; IO (IORef ReadHandle, FileSystem)
-&gt; m (IORef ReadHandle, FileSystem)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">StateT FileSystem IO (IORef ReadHandle)
-&gt; FileSystem -&gt; IO (IORef ReadHandle, FileSystem)
forall s (m :: * -&gt; *) a. StateT s m a -&gt; s -&gt; m (a, s)
</span><span class="hs-identifier hs-var hs-var">runStateT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; StateT FileSystem IO (IORef ReadHandle)
forall (m :: * -&gt; *).
(Monad m, MonadState FileSystem m, MonadIO m) =&gt;
String -&gt; m (IORef ReadHandle)
</span><a href="Main.html#readFile"><span class="hs-identifier hs-var">readFile</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679033934"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">FileSystem
</span><a href="#local-6989586621679033933"><span class="hs-identifier hs-var">fs</span></a></span><span>
</span><span id="line-338"></span><span>  </span><span id="local-6989586621679033930"><span class="annot"><span class="annottext">ReadHandle
</span><a href="#local-6989586621679033930"><span class="hs-identifier hs-var">handle</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO ReadHandle -&gt; m ReadHandle
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO ReadHandle -&gt; m ReadHandle) -&gt; IO ReadHandle -&gt; m ReadHandle
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IORef ReadHandle -&gt; IO ReadHandle
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef ReadHandle
</span><a href="#local-6989586621679033932"><span class="hs-identifier hs-var">handleRef</span></a></span><span>
</span><span id="line-339"></span><span>  </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; (String -&gt; IO ()) -&gt; String -&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; IO ()
</span><span class="hs-identifier hs-var">putStrLn</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; m ()) -&gt; String -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[String] -&gt; String
</span><span class="hs-identifier hs-var">unwords</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Reading&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679033934"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;-&gt;&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ReadHandle -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">ReadHandle
</span><a href="#local-6989586621679033930"><span class="hs-identifier hs-var">handle</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-340"></span><span>  </span><span class="annot"><span class="annottext">FileSystem -&gt; m ()
forall s (m :: * -&gt; *). MonadState s m =&gt; s -&gt; m ()
</span><span class="hs-identifier hs-var">put</span></span><span> </span><span class="annot"><span class="annottext">FileSystem
</span><a href="#local-6989586621679033931"><span class="hs-identifier hs-var">newFs</span></a></span><span>
</span><span id="line-341"></span><span class="annot"><a href="Main.html#runSimulation"><span class="hs-identifier hs-var">runSimulation</span></a></span><span> </span><span class="annot"><span class="annottext">Simulator a
</span><a href="Main.html#PrintState"><span class="hs-identifier hs-var">PrintState</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-342"></span><span>  </span><span id="local-6989586621679033929"><span class="annot"><span class="annottext">ConcreteDisk
</span><a href="#local-6989586621679033929"><span class="hs-identifier hs-var">disk</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m ConcreteDisk
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-343"></span><span>  </span><span id="local-6989586621679033928"><span class="annot"><span class="annottext">FileSystem
</span><a href="#local-6989586621679033928"><span class="hs-identifier hs-var">fs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m FileSystem
forall s (m :: * -&gt; *). MonadState s m =&gt; m s
</span><span class="hs-identifier hs-var">get</span></span><span>
</span><span id="line-344"></span><span>  </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConcreteDisk -&gt; IO ()
</span><a href="Main.html#printDisk"><span class="hs-identifier hs-var">printDisk</span></a></span><span> </span><span class="annot"><span class="annottext">ConcreteDisk
</span><a href="#local-6989586621679033929"><span class="hs-identifier hs-var">disk</span></a></span><span>
</span><span id="line-345"></span><span>  </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FileSystem -&gt; IO ()
</span><a href="Main.html#printFs"><span class="hs-identifier hs-var">printFs</span></a></span><span> </span><span class="annot"><span class="annottext">FileSystem
</span><a href="#local-6989586621679033928"><span class="hs-identifier hs-var">fs</span></a></span><span>
</span><span id="line-346"></span><span class="annot"><a href="Main.html#runSimulation"><span class="hs-identifier hs-var">runSimulation</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Main.html#Pure"><span class="hs-identifier hs-type">Pure</span></a></span><span> </span><span id="local-6989586621679033927"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679033927"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679033927"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-347"></span><span class="annot"><a href="Main.html#runSimulation"><span class="hs-identifier hs-var">runSimulation</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Main.html#Bind"><span class="hs-identifier hs-type">Bind</span></a></span><span> </span><span id="local-6989586621679033926"><span class="annot"><span class="annottext">Simulator a
</span><a href="#local-6989586621679033926"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679033925"><span class="annot"><span class="annottext">a -&gt; Simulator a
</span><a href="#local-6989586621679033925"><span class="hs-identifier hs-var">mb</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-348"></span><span>  </span><span id="local-6989586621679033924"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679033924"><span class="hs-identifier hs-var">aRes</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Simulator a -&gt; m a
forall (m :: * -&gt; *) a.
(Monad m, MonadReader ConcreteDisk m, MonadState FileSystem m,
 MonadIO m) =&gt;
Simulator a -&gt; m a
</span><a href="Main.html#runSimulation"><span class="hs-identifier hs-var">runSimulation</span></a></span><span> </span><span class="annot"><span class="annottext">Simulator a
</span><a href="#local-6989586621679033926"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-349"></span><span>  </span><span class="annot"><span class="annottext">Simulator a -&gt; m a
forall (m :: * -&gt; *) a.
(Monad m, MonadReader ConcreteDisk m, MonadState FileSystem m,
 MonadIO m) =&gt;
Simulator a -&gt; m a
</span><a href="Main.html#runSimulation"><span class="hs-identifier hs-var">runSimulation</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Simulator a
</span><a href="#local-6989586621679033925"><span class="hs-identifier hs-var">mb</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679033924"><span class="hs-identifier hs-var">aRes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-350"></span><span>
</span><span id="line-351"></span><span class="annot"><a href="Main.html#startingFileSystem"><span class="hs-identifier hs-type">startingFileSystem</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Main.html#FileSystem"><span class="hs-identifier hs-type">FileSystem</span></a></span><span>
</span><span id="line-352"></span><span id="startingFileSystem"><span class="annot"><span class="annottext">startingFileSystem :: FileSystem
</span><a href="Main.html#startingFileSystem"><span class="hs-identifier hs-var hs-var">startingFileSystem</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set File
-&gt; Set String
-&gt; ReverseLookup
-&gt; Int
-&gt; Map String (IORef ReadHandle)
-&gt; FileSystem
</span><a href="Main.html#FileSystem"><span class="hs-identifier hs-var">FileSystem</span></a></span><span> </span><span class="annot"><span class="annottext">Set File
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">Set String
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">ReverseLookup
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Map String (IORef ReadHandle)
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-353"></span><span>
</span><span id="line-354"></span><span class="annot"><a href="Main.html#mkStartingDisk"><span class="hs-identifier hs-type">mkStartingDisk</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Main.html#ConcreteDisk"><span class="hs-identifier hs-type">ConcreteDisk</span></a></span><span>
</span><span id="line-355"></span><span id="mkStartingDisk"><span class="annot"><span class="annottext">mkStartingDisk :: IO ConcreteDisk
</span><a href="Main.html#mkStartingDisk"><span class="hs-identifier hs-var hs-var">mkStartingDisk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-356"></span><span>  </span><span id="local-6989586621679033921"><span class="annot"><span class="annottext">IORef Int
</span><a href="#local-6989586621679033921"><span class="hs-identifier hs-var">startingIndex</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; IO (IORef Int)
forall a. a -&gt; IO (IORef a)
</span><span class="hs-identifier hs-var">newIORef</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-357"></span><span>  </span><span id="local-6989586621679033920"><span class="annot"><span class="annottext">IORef ContiguousData
</span><a href="#local-6989586621679033920"><span class="hs-identifier hs-var">startingContents</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ContiguousData -&gt; IO (IORef ContiguousData)
forall a. a -&gt; IO (IORef a)
</span><span class="hs-identifier hs-var">newIORef</span></span><span> </span><span class="annot"><span class="annottext">ContiguousData
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-358"></span><span>  </span><span class="hs-identifier">return</span><span> </span><span class="hs-operator">$</span><span> </span><span class="annot"><span class="annottext">Int -&gt; IORef Int -&gt; IORef ContiguousData -&gt; ConcreteDisk
</span><a href="Main.html#ConcreteDisk"><span class="hs-identifier hs-var">ConcreteDisk</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">200</span></span><span> </span><span class="annot"><span class="annottext">IORef Int
</span><a href="#local-6989586621679033921"><span class="hs-identifier hs-var">startingIndex</span></a></span><span> </span><span class="annot"><span class="annottext">IORef ContiguousData
</span><a href="#local-6989586621679033920"><span class="hs-identifier hs-var">startingContents</span></a></span><span>
</span><span id="line-359"></span><span>
</span><span id="line-360"></span><span class="annot"><a href="Main.html#main"><span class="hs-identifier hs-type">main</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-361"></span><span id="main"><span class="annot"><span class="annottext">main :: IO ()
</span><a href="Main.html#main"><span class="hs-identifier hs-var hs-var">main</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-362"></span><span>  </span><span id="local-6989586621679033918"><span class="annot"><span class="annottext">ConcreteDisk
</span><a href="#local-6989586621679033918"><span class="hs-identifier hs-var">startingDisk</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO ConcreteDisk
</span><a href="Main.html#mkStartingDisk"><span class="hs-identifier hs-var">mkStartingDisk</span></a></span><span>
</span><span id="line-363"></span><span>  </span><span class="annot"><span class="annottext">ReaderT ConcreteDisk IO () -&gt; ConcreteDisk -&gt; IO ()
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var hs-var">runReaderT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StateT FileSystem (ReaderT ConcreteDisk IO) ()
-&gt; FileSystem -&gt; ReaderT ConcreteDisk IO ()
forall (m :: * -&gt; *) s a. Monad m =&gt; StateT s m a -&gt; s -&gt; m a
</span><span class="hs-identifier hs-var">evalStateT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Simulator () -&gt; StateT FileSystem (ReaderT ConcreteDisk IO) ()
forall (m :: * -&gt; *) a.
(Monad m, MonadReader ConcreteDisk m, MonadState FileSystem m,
 MonadIO m) =&gt;
Simulator a -&gt; m a
</span><a href="Main.html#runSimulation"><span class="hs-identifier hs-var">runSimulation</span></a></span><span> </span><span class="annot"><span class="annottext">Simulator ()
</span><a href="Main.html#sampleProgram"><span class="hs-identifier hs-var">sampleProgram</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">FileSystem
</span><a href="Main.html#startingFileSystem"><span class="hs-identifier hs-var">startingFileSystem</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ConcreteDisk
</span><a href="#local-6989586621679033918"><span class="hs-identifier hs-var">startingDisk</span></a></span><span>
</span><span id="line-364"></span><span>  </span><span class="hs-comment">-- evalStateT (runReaderT (runSimulation sampleProgram) startingDisk) startingFileSystem</span><span>
</span><span id="line-365"></span></pre></body></html>